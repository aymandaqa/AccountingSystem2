@model AccountingSystem.ViewModels.PaginatedListViewModel<AccountingSystem.ViewModels.TransactionListItemViewModel>
@using Microsoft.AspNetCore.Mvc.Rendering
@using System.Globalization
@using System.Linq

@{
    ViewData["Title"] = "كل الحركات";
    var pageSizeOptions = new[] { 10, 25, 50, 100 };
    var branches = ViewBag.UserBranches as IEnumerable<SelectListItem> ?? Enumerable.Empty<SelectListItem>();
    int? selectedBranchId = ViewBag.SelectedBranchId as int?;
    var fromDateValue = Model.FromDate?.ToString("yyyy-MM-dd");
    var toDateValue = Model.ToDate?.ToString("yyyy-MM-dd");
    var searchTerm = Model.SearchTerm ?? string.Empty;
}

<div class="card shadow-sm">
    <div class="card-header bg-white py-3 d-flex flex-column flex-lg-row justify-content-between align-items-lg-center gap-3">
        <div>
            <h1 class="h4 mb-1">كل الحركات المالية</h1>
            <p class="text-muted mb-0">عرض موحد لسندات القبض والصرف والدفع ومصاريف الأصول بحسب فروع المستخدم.</p>
        </div>
    </div>
    <div class="card-body">
        <form method="get" class="row g-3 align-items-end mb-4" asp-action="Index">
            <div class="col-12 col-md-3">
                <label for="fromDate" class="form-label">من تاريخ</label>
                <input type="date" id="fromDate" name="fromDate" class="form-control" value="@fromDateValue" />
            </div>
            <div class="col-12 col-md-3">
                <label for="toDate" class="form-label">إلى تاريخ</label>
                <input type="date" id="toDate" name="toDate" class="form-control" value="@toDateValue" />
            </div>
            <div class="col-12 col-md-3">
                <label for="branchId" class="form-label">الفرع</label>
                <select id="branchId" name="branchId" class="form-select">
                    <option value="">كل الفروع المسموح بها</option>
                    @foreach (var branch in branches)
                    {
                        <option value="@branch.Value" selected="@(selectedBranchId.HasValue && branch.Value == selectedBranchId?.ToString() ? "selected" : null)">@branch.Text</option>
                    }
                </select>
            </div>
            <div class="col-12 col-md-3">
                <label for="searchTerm" class="form-label">بحث عام</label>
                <input type="text" id="searchTerm" name="searchTerm" class="form-control" value="@searchTerm" placeholder="بحث في نوع الحركة، الطرف، الملاحظات أو الحالة" />
            </div>
            <div class="col-12 col-md-2">
                <label for="pageSize" class="form-label">عدد السجلات</label>
                <select id="pageSize" name="pageSize" class="form-select">
                    @foreach (var option in pageSizeOptions)
                    {
                        <option value="@option" selected="@(Model.PageSize == option ? "selected" : null)">@option</option>
                    }
                </select>
            </div>
            <div class="col-12 d-flex flex-wrap gap-2 justify-content-end">
                <input type="hidden" name="page" value="1" />
                <button type="submit" class="btn btn-primary"><i class="fas fa-filter ms-1"></i> تطبيق</button>
                <a asp-action="Index" class="btn btn-outline-secondary"><i class="fas fa-undo ms-1"></i> إعادة تعيين</a>
            </div>
        </form>

        <div class="table-responsive">
            <table class="table table-striped table-hover align-middle">
                <thead class="table-light">
                    <tr>
                        <th scope="col">التاريخ</th>
                        <th scope="col">نوع الحركة</th>
                        <th scope="col">الطرف / البيان</th>
                        <th scope="col">المبلغ</th>
                        <th scope="col">العملة</th>
                        <th scope="col">الفرع</th>
                        <th scope="col">الحالة</th>
                        <th scope="col">ملاحظات</th>
                        <th scope="col" class="text-end">التفاصيل</th>
                    </tr>
                </thead>
                <tbody>
                    @if (!Model.Items.Any())
                    {
                        <tr>
                            <td colspan="9" class="text-center text-muted">لا توجد بيانات مطابقة للمرشحات الحالية.</td>
                        </tr>
                    }
                    else
                    {
                        foreach (var item in Model.Items)
                        {
                            var displayNotes = string.IsNullOrWhiteSpace(item.Notes) ? "-" : item.Notes;
                            var displayCounterparty = string.IsNullOrWhiteSpace(item.Counterparty) ? "-" : item.Counterparty;
                        <tr>
                            <td class="text-nowrap">@item.Date.ToString("dd/MM/yyyy HH:mm")</td>
                            <td>@item.Type</td>
                            <td>@displayCounterparty</td>
                            <td class="text-nowrap">@item.Amount.ToString("N2", CultureInfo.CurrentCulture)</td>
                            <td>@item.CurrencyCode</td>
                            <td>@item.BranchName</td>
                            <td>@(string.IsNullOrWhiteSpace(item.Status) ? "-" : item.Status)</td>
                            <td>@displayNotes</td>
                            <td class="text-end">
                                <a class="btn btn-sm btn-outline-primary"
                                   asp-controller="@item.DetailsController"
                                   asp-action="@item.DetailsAction"
                                   asp-route-id="@item.Id">
                                    <i class="fas fa-arrow-up-right-from-square ms-1"></i> عرض
                                </a>
                            </td>
                        </tr>
                        }
                    }
                </tbody>
            </table>
        </div>

        @if (Model.TotalPages > 1)
        {
            var startPage = Math.Max(1, Model.PageIndex - 2);
            var endPage = Math.Min(Model.TotalPages, Model.PageIndex + 2);
        <nav aria-label="التنقل بين الصفحات">
            <ul class="pagination justify-content-center">
                <li class="page-item @(Model.PageIndex == 1 ? "disabled" : null)">
                    <a class="page-link" href="@Url.Action("Index", new { page = Model.PageIndex - 1, pageSize = Model.PageSize, fromDate = fromDateValue, toDate = toDateValue, searchTerm = searchTerm, branchId = selectedBranchId })">السابق</a>
                </li>
                @for (var pageNumber = startPage; pageNumber <= endPage; pageNumber++)
                {
                    <li class="page-item @(pageNumber == Model.PageIndex ? "active" : null)">
                        <a class="page-link" href="@Url.Action("Index", new { page = pageNumber, pageSize = Model.PageSize, fromDate = fromDateValue, toDate = toDateValue, searchTerm = searchTerm, branchId = selectedBranchId })">@pageNumber</a>
                    </li>
                }
                <li class="page-item @(Model.PageIndex == Model.TotalPages ? "disabled" : null)">
                    <a class="page-link" href="@Url.Action("Index", new { page = Model.PageIndex + 1, pageSize = Model.PageSize, fromDate = fromDateValue, toDate = toDateValue, searchTerm = searchTerm, branchId = selectedBranchId })">التالي</a>
                </li>
            </ul>
        </nav>
        }
    </div>
</div>
