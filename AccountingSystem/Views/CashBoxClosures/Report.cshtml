@model AccountingSystem.ViewModels.CashBoxClosureReportViewModel
@{
    ViewData["Title"] = "تقرير إغلاقات الصندوق";
}

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card shadow">
                <div class="card-header bg-info text-white">
                    <h4 class="mb-0"><i class="fas fa-file-alt me-2"></i> تقرير إغلاقات الصندوق</h4>
                </div>
                <div class="card-body">
                    <form method="get" class="row g-3 mb-4">
                        <div class="col-md-4">
                            <label class="form-label">الحساب</label>
                            <select name="accountId" class="form-select">
                                <option value="">كل الحسابات</option>
                                @foreach (var acc in Model.Accounts)
                                {
                                    <option value="@acc.Value" selected="@(Model.AccountId?.ToString() == acc.Value ? "selected" : null)">@acc.Text</option>
                                }
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">من تاريخ</label>
                            <input type="date" name="fromDate" class="form-control" value="@(Model.FromDate?.ToString("yyyy-MM-dd"))" />
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">إلى تاريخ</label>
                            <input type="date" name="toDate" class="form-control" value="@(Model.ToDate?.ToString("yyyy-MM-dd"))" />
                        </div>
                        <div class="col-md-2 d-flex align-items-end">
                            <button type="submit" class="btn btn-info me-2"><i class="fas fa-search me-1"></i> بحث</button>
                            @if (Model.Closures.Any())
                            {
                                <a class="btn btn-success" href="@Url.Action("Export", new {accountId = Model.AccountId, fromDate = Model.FromDate?.ToString("yyyy-MM-dd"), toDate = Model.ToDate?.ToString("yyyy-MM-dd")})">
                                    <i class="fas fa-file-excel me-1"></i> تصدير
                                </a>
                            }
                        </div>
                    </form>

                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead class="table-dark">
                                <tr>
                                    <th>تاريخ الإنشاء</th>
                                    <th>تاريخ الإغلاق</th>
                                    <th>المستخدم</th>
                                    <th>الحساب</th>
                                    <th>الفرع</th>
                                    <th class="text-end">الرصيد الافتتاحي</th>
                                    <th class="text-end">المبلغ المعدود</th>
                                    <th class="text-end">الرصيد المتوقع</th>
                                    <th class="text-end">الرصيد الختامي</th>
                                    <th class="text-end">قيمة الفرق</th>
                                    <th>نوع الفرق</th>
                                    <th>الحالة</th>
                                    <th>الملاحظات</th>
                                    <th>ملاحظات الاعتماد</th>
                                </tr>
                            </thead>
                            <tbody>
                                @if (Model.Closures.Any())
                                {
                                    foreach (var c in Model.Closures)
                                    {
                                        var expectedBalance = c.ClosingBalance - c.OpeningBalance;
                                        <tr>
                                            <td>@c.CreatedAt.ToString("dd/MM/yyyy HH:mm")</td>
                                            <td>@(c.ClosingDate.HasValue ? c.ClosingDate.Value.ToString("dd/MM/yyyy HH:mm") : "-")</td>
                                            <td>@c.UserName</td>
                                            <td>@c.AccountName</td>
                                            <td>@c.BranchName</td>
                                            <td class="text-end">@c.OpeningBalance.ToString("N2")</td>
                                            <td class="text-end">@c.CountedAmount.ToString("N2")</td>
                                            <td class="text-end">@expectedBalance.ToString("N2")</td>
                                            <td class="text-end">@c.ClosingBalance.ToString("N2")</td>
                                            <td class="text-end">@c.Difference.ToString("N2")</td>
                                            <td>@c.DifferenceType</td>
                                            <td>@c.Status</td>
                                            <td>@(string.IsNullOrWhiteSpace(c.Notes) ? "-" : c.Notes)</td>
                                            <td>@(string.IsNullOrWhiteSpace(c.ApprovalNotes) ? "-" : c.ApprovalNotes)</td>
                                        </tr>
                                    }
                                }
                                else
                                {
                                    <tr>
                                        <td colspan="14" class="text-center text-muted">لا توجد بيانات</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
