@model AccountingSystem.ViewModels.AccountSettlementIndexViewModel
@using System.Globalization

@{
    ViewData["Title"] = "تسوية حساب مالي";
    var hasAccount = Model.AccountId.HasValue;
}

<div class="card shadow-sm mb-4">
    <div class="card-header bg-white py-3">
        <h1 class="h4 mb-1">تسوية حساب مالي</h1>
        <p class="text-muted mb-0">فصل الحركات المدينة والدائنة يدويًا وتحويل الحركات المتطابقة إلى كشف التسويات بشكل منظم.</p>
    </div>
    <div class="card-body">
        <form method="get" class="row g-3 align-items-end">
            <div class="col-12 col-lg-6">
                <label class="form-label fw-semibold">اختر الحساب</label>
                <select class="form-select account-search" name="accountId" asp-items="Model.Accounts" data-placeholder="ابحث باسم أو رقم الحساب">
                    <option value="">-- اختر حساباً --</option>
                </select>
                <div class="form-text">يتم تحديث الحركات غير المسوّاة تلقائياً عند اختيار الحساب أو إعادة التحميل.</div>
            </div>
            <div class="col-12 col-lg-3">
                <label class="form-label fw-semibold">من تاريخ</label>
                <input type="date" class="form-control" name="fromDate" value="@Model.FromDate?.ToString("yyyy-MM-dd")" />
                <div class="form-text">تصفية الحركات بناءً على تاريخ القيد.</div>
            </div>
            <div class="col-12 col-lg-3">
                <label class="form-label fw-semibold">إلى تاريخ</label>
                <input type="date" class="form-control" name="toDate" value="@Model.ToDate?.ToString("yyyy-MM-dd")" />
                <div class="form-text">تاريخ النهاية لنتائج البحث.</div>
            </div>
            <div class="col-12 col-lg-3 d-flex align-items-end">
                <button type="submit" class="btn btn-primary w-100">
                    <i class="fa-solid fa-filter ms-1"></i> عرض الحركات
                </button>
            </div>
        </form>
    </div>
</div>

@if (TempData["Success"] != null)
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        <i class="fa-solid fa-check-circle ms-1"></i> @TempData["Success"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}
@if (TempData["Error"] != null)
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        <i class="fa-solid fa-circle-exclamation ms-1"></i> @TempData["Error"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

@if (hasAccount)
{
    <form asp-action="Settle" method="post">
        @Html.AntiForgeryToken()
        <input type="hidden" name="AccountId" value="@Model.AccountId" />
        <input type="hidden" name="FromDate" value="@Model.FromDate?.ToString("o")" />
        <input type="hidden" name="ToDate" value="@Model.ToDate?.ToString("o")" />
        <div class="row g-3 mb-2">
            <div class="col-12 col-lg-4">
                <label class="form-label fw-semibold">تاريخ التسوية</label>
                <input type="datetime-local"
                       class="form-control"
                       name="SettlementDate"
                       value="@Model.SettlementDate.ToString("yyyy-MM-ddTHH:mm")" />
                <div class="form-text">سيتم استخدام هذا التاريخ لحفظ المطابقة، ويتم ضبطه تلقائياً بناءً على نطاق البحث.</div>
            </div>
        </div>
        <div class="row g-3">
            <div class="col-12 col-lg-6">
                <div class="card h-100">
                    <div class="card-header bg-light py-3 d-flex justify-content-between align-items-center">
                        <div>
                            <h2 class="h5 mb-0">الحركات المدينة غير المسوّاة</h2>
                            <small class="text-muted">حدد الحركات التي ترغب في تسويتها من الجانب المدين.</small>
                        </div>
                        <span class="badge bg-primary">@Model.DebitLines.Count</span>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th style="width: 50px;"></th>
                                    <th>التاريخ</th>
                                    <th>رقم القيد</th>
                                    <th>البيان</th>
                                    <th class="text-end">المبلغ (مدين)</th>
                                </tr>
                            </thead>
                            <tbody>
                                @if (Model.DebitLines.Any())
                                {
                                    foreach (var line in Model.DebitLines)
                                    {
                                        <tr>
                                              <td>
                                                  <input class="form-check-input debit-checkbox" type="checkbox" name="SelectedDebitIds" value="@line.LineId" data-amount="@line.Debit.ToString(CultureInfo.InvariantCulture)" />
                                              </td>
                                            <td>@line.Date.ToString("yyyy-MM-dd", CultureInfo.InvariantCulture)</td>
                                            <td>@line.JournalNumber</td>
                                            <td>
                                                <div class="fw-semibold">@line.Description</div>
                                                @if (!string.IsNullOrWhiteSpace(line.Reference))
                                                {
                                                    <small class="text-muted">@line.Reference</small>
                                                }
                                            </td>
                                              <td class="text-end text-success fw-semibold">@line.Debit.ToString("N2", CultureInfo.InvariantCulture)</td>
                                        </tr>
                                    }
                                }
                                else
                                {
                                    <tr>
                                        <td colspan="5" class="text-center text-muted py-4">لا توجد حركات مدينة غير مسوّاة.</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="col-12 col-lg-6">
                <div class="card h-100">
                    <div class="card-header bg-light py-3 d-flex justify-content-between align-items-center">
                        <div>
                            <h2 class="h5 mb-0">الحركات الدائنة غير المسوّاة</h2>
                            <small class="text-muted">حدد الحركات التي ترغب في تسويتها من الجانب الدائن.</small>
                        </div>
                        <span class="badge bg-secondary">@Model.CreditLines.Count</span>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th style="width: 50px;"></th>
                                    <th>التاريخ</th>
                                    <th>رقم القيد</th>
                                    <th>البيان</th>
                                    <th class="text-end">المبلغ (دائن)</th>
                                </tr>
                            </thead>
                            <tbody>
                                @if (Model.CreditLines.Any())
                                {
                                    foreach (var line in Model.CreditLines)
                                    {
                                        <tr>
                                              <td>
                                                  <input class="form-check-input credit-checkbox" type="checkbox" name="SelectedCreditIds" value="@line.LineId" data-amount="@line.Credit.ToString(CultureInfo.InvariantCulture)" />
                                              </td>
                                            <td>@line.Date.ToString("yyyy-MM-dd", CultureInfo.InvariantCulture)</td>
                                            <td>@line.JournalNumber</td>
                                            <td>
                                                <div class="fw-semibold">@line.Description</div>
                                                @if (!string.IsNullOrWhiteSpace(line.Reference))
                                                {
                                                    <small class="text-muted">@line.Reference</small>
                                                }
                                            </td>
                                              <td class="text-end text-danger fw-semibold">@line.Credit.ToString("N2", CultureInfo.InvariantCulture)</td>
                                        </tr>
                                    }
                                }
                                else
                                {
                                    <tr>
                                        <td colspan="5" class="text-center text-muted py-4">لا توجد حركات دائنة غير مسوّاة.</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="alert alert-light border mt-3" role="alert">
            <div class="d-flex flex-wrap gap-3 align-items-center">
                <div class="fw-semibold text-success">إجمالي المدين المحدد: <span id="selectedDebitTotal">0.00</span></div>
                <div class="fw-semibold text-danger">إجمالي الدائن المحدد: <span id="selectedCreditTotal">0.00</span></div>
                <div class="fw-semibold" id="balanceStatus">لم يتم اختيار حركات بعد.</div>
            </div>
        </div>

        <div class="d-flex justify-content-end mt-3 gap-2">
            <div class="text-muted small me-auto">تُضاف الحركات المحددة كتسوية واحدة بحيث تظهر كسطر واحد في كشف التسويات أدناه.</div>
            <button type="submit" class="btn btn-success">
                <i class="fa-solid fa-link ms-1"></i> إضافة كتسوية واحدة
            </button>
        </div>
    </form>

        <div class="card shadow-sm mt-4">
            <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="h5 mb-0">كشف التسويات</h2>
                    <small class="text-muted">يتم عرض كل تسوية في سطر واحد حتى لو تضمنت عدة حركات مدينة أو دائنة.</small>
                </div>
                <div class="d-flex align-items-center gap-2">
                    <span class="badge bg-info">@Model.Settlements.Count</span>
                    @if (Model.AccountId.HasValue)
                    {
                        <a class="btn btn-sm btn-outline-primary" href="@Url.Action("ExportToExcel", new { accountId = Model.AccountId, fromDate = Model.FromDate?.ToString("yyyy-MM-dd"), toDate = Model.ToDate?.ToString("yyyy-MM-dd") })">
                            <i class="fa-solid fa-file-excel ms-1"></i> تصدير إكسل
                        </a>
                        <button type="button" class="btn btn-sm btn-outline-secondary" id="printSettlements">
                            <i class="fa-solid fa-print ms-1"></i> طباعة
                        </button>
                    }
                </div>
            </div>
        <div class="table-responsive">
            <table class="table align-middle mb-0">
                <thead class="table-light">
                    <tr>
                        <th style="width: 140px;">تاريخ التسوية</th>
                        <th>الحركة المدينة</th>
                        <th>الحركة الدائنة</th>
                        <th style="width: 160px;" class="text-center">إجراءات</th>
                    </tr>
                </thead>
                <tbody>
                    @if (Model.Settlements.Any())
                    {
                        foreach (var settlement in Model.Settlements)
                        {
                            <tr>
                                <td class="text-nowrap">@settlement.CreatedAt.ToString("yyyy-MM-dd HH:mm", CultureInfo.InvariantCulture)</td>
                                <td>
                                    <div class="d-flex flex-column gap-2">
                                        @foreach (var debit in settlement.DebitLines)
                                        {
                                            <div>
                                                <div class="fw-semibold">@debit.Description</div>
                                                <div class="text-muted small">رقم القيد: @debit.JournalNumber | التاريخ: @debit.Date.ToString("yyyy-MM-dd", CultureInfo.InvariantCulture)</div>
                                                <div class="text-success fw-semibold">@debit.Debit.ToString("N2", CultureInfo.InvariantCulture)</div>
                                            </div>
                                        }
                                    </div>
                                    <div class="text-success fw-semibold mt-2">الإجمالي: @settlement.DebitTotal.ToString("N2", CultureInfo.InvariantCulture)</div>
                                </td>
                                <td>
                                    <div class="d-flex flex-column gap-2">
                                        @foreach (var credit in settlement.CreditLines)
                                        {
                                            <div>
                                                <div class="fw-semibold">@credit.Description</div>
                                                <div class="text-muted small">رقم القيد: @credit.JournalNumber | التاريخ: @credit.Date.ToString("yyyy-MM-dd", CultureInfo.InvariantCulture)</div>
                                                <div class="text-danger fw-semibold">@credit.Credit.ToString("N2", CultureInfo.InvariantCulture)</div>
                                            </div>
                                        }
                                    </div>
                                    <div class="text-danger fw-semibold mt-2">الإجمالي: @settlement.CreditTotal.ToString("N2", CultureInfo.InvariantCulture)</div>
                                </td>
                                <td class="text-center">
                                    <form asp-action="DeleteSettlement" method="post" class="d-inline">
                                        @Html.AntiForgeryToken()
                                        <input type="hidden" name="settlementId" value="@settlement.SettlementId" />
                                        <input type="hidden" name="accountId" value="@Model.AccountId" />
                                        <input type="hidden" name="fromDate" value="@Model.FromDate?.ToString("o")" />
                                        <input type="hidden" name="toDate" value="@Model.ToDate?.ToString("o")" />
                                        <button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('هل أنت متأكد من إلغاء هذه التسوية؟');">
                                            <i class="fa-solid fa-rotate-left ms-1"></i> إلغاء التسوية بالكامل
                                        </button>
                                    </form>
                                </td>
                            </tr>
                        }
                    }
                    else
                    {
                        <tr>
                            <td colspan="4" class="text-center text-muted py-4">لم يتم تسجيل أي تسويات لهذا الحساب بعد.</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
}
else
{
    <div class="alert alert-info">
        <i class="fa-solid fa-info-circle ms-1"></i> يرجى اختيار حساب لعرض الحركات غير المسوّاة وإجراء التسويات.
    </div>
}

@section Styles {
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
}

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script>
        (function () {
            const accountSelect = $('.account-search');
            if (accountSelect.length) {
                accountSelect.select2({
                    dir: 'rtl',
                    width: '100%',
                    placeholder: accountSelect.data('placeholder')
                });
            }

            const debitCheckboxes = document.querySelectorAll('.debit-checkbox');
            const creditCheckboxes = document.querySelectorAll('.credit-checkbox');
            const debitTotalEl = document.getElementById('selectedDebitTotal');
            const creditTotalEl = document.getElementById('selectedCreditTotal');
            const statusEl = document.getElementById('balanceStatus');

            const formatAmount = (value) => value.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            const parseAmount = (value) => {
                if (!value) {
                    return 0;
                }

                const cleaned = value.replace(/,/g, '');
                const parsed = Number.parseFloat(cleaned);
                return Number.isNaN(parsed) ? 0 : parsed;
            };

            const updateTotals = () => {
                let debitTotal = 0;
                let creditTotal = 0;

                debitCheckboxes.forEach(cb => {
                    if (cb.checked) {
                        debitTotal += parseAmount(cb.dataset.amount);
                    }
                });

                creditCheckboxes.forEach(cb => {
                    if (cb.checked) {
                        creditTotal += parseAmount(cb.dataset.amount);
                    }
                });

                debitTotalEl.textContent = formatAmount(debitTotal);
                creditTotalEl.textContent = formatAmount(creditTotal);

                statusEl.classList.remove('text-success', 'text-danger');

                if (debitTotal === 0 && creditTotal === 0) {
                    statusEl.textContent = 'لم يتم اختيار حركات بعد.';
                } else if (debitTotal === creditTotal) {
                    statusEl.textContent = 'المجاميع متساوية وجاهزة للتسوية.';
                    statusEl.classList.add('text-success');
                } else {
                    const difference = debitTotal - creditTotal;
                    statusEl.textContent = `هناك فرق قدره ${formatAmount(difference)} بين الجانبين.`;
                    statusEl.classList.add('text-danger');
                }
            };

            debitCheckboxes.forEach(cb => cb.addEventListener('change', updateTotals));
            creditCheckboxes.forEach(cb => cb.addEventListener('change', updateTotals));

            document.getElementById('printSettlements')?.addEventListener('click', () => window.print());

            updateTotals();
        })();
    </script>
}
