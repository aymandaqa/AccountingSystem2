@using System.Globalization
@{
    ViewData["Title"] = "الموردين";
    var rtl = CultureInfo.CurrentUICulture.TextInfo.IsRightToLeft;
    var dataUrl = Url.Action("UrlDatasource", "Suppliers");
    var createUrl = Url.Action("Create", "Suppliers");
    var exportUrl = Url.Action("ExportExcel", "Suppliers");
}

<div class="card shadow-sm">
    <div class="card-header bg-white py-3 d-flex flex-column flex-lg-row justify-content-between align-items-lg-center gap-3">
        <div>
            <h1 class="h4 mb-1">إدارة الموردين</h1>
            <p class="text-muted mb-0">قائمة الموردين مع ترشيح Excel وخوادم متكاملة للحصول على نتائج دقيقة.</p>
        </div>
        <div class="d-flex flex-wrap gap-2">
            <a class="btn btn-primary" href="@createUrl" asp-require-permission="suppliers.create">
                <i class="fas fa-plus-circle ms-1"></i> مورد جديد
            </a>
            <a class="btn btn-success" href="@exportUrl" asp-require-permission="suppliers.view">
                <i class="fas fa-file-excel ms-1"></i> تصدير Excel
            </a>
        </div>
    </div>
    <div class="card-body">
        <div class="mb-3 text-muted small">يمكنك استخدام فلاتر Excel أو البحث العام في الشريط العلوي للوصول إلى المورد المطلوب.</div>
        <ejs-grid id="SuppliersGrid"
                  gridLines="Both"
                  enableRtl="@rtl"
                  allowPaging="true"
                  allowSorting="true"
                  allowFiltering="true"
                  toolbar="@(new[] { "Search" })"
                  dataBound="onSuppliersDataBound">
            <e-grid-pagesettings pageCount="5" pageSizes="true"></e-grid-pagesettings>
            <e-grid-filterSettings type="Excel" immediateModeDelay="100"></e-grid-filterSettings>
            <e-grid-editSettings allowAdding="false" allowDeleting="false" allowEditing="false"></e-grid-editSettings>
            <e-data-manager url="@dataUrl" adaptor="UrlAdaptor"></e-data-manager>
            <e-grid-columns>
                <e-grid-column field="Id" isPrimaryKey="true" visible="false" width="40" allowEditing="false"></e-grid-column>
                <e-grid-column field="Name" headerText="الاسم" width="180"></e-grid-column>
                <e-grid-column field="Phone" headerText="التليفون" width="140"></e-grid-column>
                <e-grid-column field="Email" headerText="البريد الإلكتروني" width="180"></e-grid-column>
                <e-grid-column field="SupplierType" headerText="نوع المورد" width="140"></e-grid-column>
                <e-grid-column field="Permissions" headerText="الصلاحيات" width="200"></e-grid-column>
                <e-grid-column field="Branches" headerText="الفروع المسموح بها" width="200"></e-grid-column>
                <e-grid-column field="CreatedBy" headerText="المستخدم" width="150"></e-grid-column>
                <e-grid-column field="CreatedAt" headerText="وقت الإنشاء" type="datetime" format="yyyy-MM-dd HH:mm" width="160"></e-grid-column>
                <e-grid-column field="Balance" headerText="رصيد المورد" textAlign="Right" format="N2" width="140"></e-grid-column>
                <e-grid-column field="CurrencyCode" headerText="العملة" width="100"></e-grid-column>
                <e-grid-column headerText="الإجراءات" textAlign="Center" width="180" template="#supplier-actions-template"></e-grid-column>
            </e-grid-columns>
        </ejs-grid>
    </div>
</div>

<form id="antiForgeryForm" asp-antiforgery="true"></form>

<script id="supplier-actions-template" type="text/x-template">
    <div class="btn-group btn-group-sm" role="group">
        ${if(AccountId)}
        <a class="btn btn-outline-success" href="/Reports/AccountStatement?accountId=${AccountId}" target="_blank" data-permission="statement" title="كشف الحساب">
            <i class="fas fa-file-alt"></i>
        </a>
        ${/if}
        <a class="btn btn-outline-warning" href="/Suppliers/Edit/${Id}" data-permission="edit" title="تعديل">
            <i class="fas fa-edit"></i>
        </a>
        <button type="button" class="btn btn-outline-danger" data-permission="delete" onclick="deleteSupplier(${Id})" title="حذف">
            <i class="fas fa-trash"></i>
        </button>
    </div>
</script>

@section Scripts {
    <script>
        const supplierPermissions = {
            canEdit: @User.HasClaim(c => c.Type == "Permission" && c.Value == "suppliers.edit").ToString().ToLower() == "true",
            canDelete: @User.HasClaim(c => c.Type == "Permission" && c.Value == "suppliers.delete").ToString().ToLower() == "true",
            canViewStatement: @User.HasClaim(c => c.Type == "Permission" && c.Value == "reports.accountstatement").ToString().ToLower() == "true"
        };

        function onSuppliersDataBound() {
            const gridElement = document.getElementById('SuppliersGrid');
            const grid = gridElement?.ej2_instances?.[0];
            if (!gridElement || !grid) {
                return;
            }

            if (!supplierPermissions.canEdit) {
                gridElement.querySelectorAll('[data-permission="edit"]').forEach(btn => btn.remove());
            }

            if (!supplierPermissions.canDelete) {
                gridElement.querySelectorAll('[data-permission="delete"]').forEach(btn => btn.remove());
            }

            if (!supplierPermissions.canViewStatement) {
                gridElement.querySelectorAll('[data-permission="statement"]').forEach(btn => btn.remove());
            }
        }

        async function deleteSupplier(id) {
            if (!supplierPermissions.canDelete) {
                return;
            }

            if (!confirm('هل أنت متأكد من حذف المورد؟')) {
                return;
            }

            const tokenField = document.querySelector('#antiForgeryForm input[name="__RequestVerificationToken"]');
            const token = tokenField ? tokenField.value : '';

            const response = await fetch('@Url.Action("Delete")', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8',
                    'RequestVerificationToken': token
                },
                body: new URLSearchParams({ id })
            });

            if (response.ok) {
                const grid = document.getElementById('SuppliersGrid')?.ej2_instances?.[0];
                grid?.refresh();
            }
        }
    </script>
}
