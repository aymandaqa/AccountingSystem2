@using Newtonsoft.Json

@{
    var rtl = true;
    ViewData["Title"] = "حساب العميل";
}


<style>
    .action-toolbar {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 0.75rem;
        padding: 0.5rem 0;
    }

    .action-toolbar .btn {
        min-width: 110px;
        box-shadow: 0 4px 10px rgba(29, 191, 193, 0.2);
        border-radius: 6px;
    }

    .summary-card {
        display: flex;
        flex-wrap: wrap;
        gap: 1.5rem;
        align-items: center;
        background: #f6fbfb;
        border: 1px solid rgba(29, 191, 193, 0.15);
        border-radius: 12px;
        padding: 1rem 1.5rem;
        margin-bottom: 1rem;
        color: #0b5d60;
        box-shadow: 0 6px 16px rgba(15, 76, 92, 0.08);
    }

    .summary-card .summary-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 15px;
    }

    .summary-card .summary-label {
        font-weight: 600;
    }

    .summary-card .summary-value {
        font-weight: 700;
        color: #0d1b2a;
        min-width: 60px;
        text-align: start;
    }

    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.55);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 2000;
        backdrop-filter: blur(3px);
    }

    .loading-overlay.hidden {
        display: none;
    }

    .loading-overlay .spinner {
        width: 70px;
        height: 70px;
        border-radius: 50%;
        border: 5px solid rgba(255, 255, 255, 0.35);
        border-top-color: #1dbfc1;
        animation: spin 1s linear infinite;
    }

    .loading-overlay .loading-text {
        margin-top: 1rem;
        font-size: 1.2rem;
        color: #fff;
        font-weight: 600;
        letter-spacing: 0.5px;
    }

    .no-scroll {
        overflow: hidden !important;
    }

    @keyframes spin {
        to {
            transform: rotate(360deg);
        }
    }
</style>

<div class="container-full">


    <!-- Main content -->
    <section class="content">
        <div class="row">
            <div class="col-12">
                <div class="box">
                    <div class="box-body">
                        <div class="col-12" id="bodytarg2">
                            <div class="action-toolbar">
                                <button class="btn btn-primary btn-sm" id="Excel" onclick="ExportExcel()">  <i class="ti-layout"></i> اكسل</button>
                                <button class="btn btn-primary btn-sm" onclick="print()" id="Print">  <i class="ti-printer"></i> طباعة</button>

                                <button class="btn btn-primary btn-sm" id="pay" onclick="pay()">  <i class="ti-money"></i> دفع</button>

                                <button class="btn btn-primary btn-sm" id="reload" onclick="Refresh()">  <i class="ti-reload"></i> تحديث</button>
                            </div>
                        </div>
                        <div class="col-12" id="bodytarg2">
                            <div class="summary-card">
                                <div class="summary-item">
                                    <span class="summary-label">عدد الطرود:</span>
                                    <span class="summary-value" id="shipRetCount"></span>
                                </div>
                                <div class="summary-item">
                                    <span class="summary-label">مجموع العمولة:</span>
                                    <span class="summary-value" id="commSum"></span>
                                </div>
                                <div class="summary-item">
                                    <span class="summary-label">مجموع العمولات الاضافية:</span>
                                    <span class="summary-value" id="ExtraFees"></span>
                                </div>
                                <div class="summary-item">
                                    <span class="summary-label">مجموع مبالغ الطرود:</span>
                                    <span class="summary-value" id="shipTotSum"></span>
                                </div>
                                <div class="summary-item">
                                    <span class="summary-label">الصافي:</span>
                                    <span class="summary-value" id="total"></span>
                                </div>
                            </div>
                        </div>
                        <div class="col=md-12">
                            <div class="row">
                                @*  <div class="col-xs-6 col-sm-4">
                                <ejs-dropdownlist id="City" name="Driver" Query="new ej.data.Query()"
                                allowFiltering="true" dataSource="@ViewBag.Driver" placeholder="السائق" change="GetDriverStmt">
                                <e-dropdownlist-fields text="FirstName" value="Id"></e-dropdownlist-fields>
                                </ejs-dropdownlist>
                                </div>    </div>*@
                                <div class="col-xs-6 col-sm-3">
                                    <ejs-dropdownlist id="CompanyBranches" name="CompanyBranches" Query="new ej.data.Query()"
                                                      allowFiltering="true" dataSource="@ViewBag.CompanyBranches" placeholder="الفرع" change="GetBus">


                                        <e-dropdownlist-fields text="BranchName" value="Id"></e-dropdownlist-fields>
                                    </ejs-dropdownlist>
                                </div>
                                <div class="col-xs-6 col-sm-3">
                                    <ejs-dropdownlist id="User" name="User" Query="new ej.data.Query()"
                                                      allowFiltering="true" placeholder="العميل" change="GetuserStmt">
                                        <e-data-manager adaptor="UrlAdaptor" url="/AccountManagement/GetBusnissUser/"></e-data-manager>
                                        <e-dropdownlist-fields text="Name" value="Id"></e-dropdownlist-fields>
                                    </ejs-dropdownlist>
                                </div>
                                <div class="col-xs-6 col-sm-3">
                                    <ejs-dropdownlist id="UserM" name="UserM" Query="new ej.data.Query()"
                                                      allowFiltering="true" placeholder="المسوق" change="GetuserStmt2">
                                        <e-data-manager adaptor="UrlAdaptor" url="/AccountManagement/GetMBusnissUser/"></e-data-manager>
                                        <e-dropdownlist-fields text="Name" value="Id"></e-dropdownlist-fields>
                                    </ejs-dropdownlist>
                                </div>
                                <div class="col-xs-6 col-sm-3">
                                    <ejs-dropdownlist id="InvoiceStatus" name="InvoiceStatus" Query="new ej.data.Query()"
                                                      allowFiltering="true" dataSource="@ViewBag.Driver" placeholder="السائق">
                                        <e-dropdownlist-fields text="Name" value="Id"></e-dropdownlist-fields>
                                    </ejs-dropdownlist>
                                </div>

                            </div>
                            <ejs-grid id="Grid" allowFiltering="true" gridLines="Both" enableRtl="@rtl" allowPaging="false" allowSorting="true" allowFiltering="true"
                                      width="100%"
                                      allowExcelExport="true" allowPdfExport="true"
                                      enableStickyHeader="true" height="400px" allowTextWrap="true" recordClick="recordClick"
                                      allowSelection="true" rowSelected="rowSelected">
                                <e-data-manager url="/AccountManagement/UrlDatasourceBusnissStatment" adaptor="UrlAdaptor"></e-data-manager>
                                <e-grid-filterSettings type="Menu"></e-grid-filterSettings>
                                <e-grid-aggregates>
                                    <e-grid-aggregate>
                                        <e-aggregate-columns>
                                            <e-aggregate-column field="ShipmentTrackingNo" type="Count" footerTemplate="عدد الشحنات:(${Count})"></e-aggregate-column>
                                            <e-aggregate-column field="ShipmentTotal" type="Sum" footerTemplate="مجموع الشحنات:(${Sum})"></e-aggregate-column>
                                            <e-aggregate-column field="ShipmentPrice" type="Sum" footerTemplate="مجموع سعر الشحنات:(${Sum})"></e-aggregate-column>
                                            <e-aggregate-column field="ShipmentFees" type="Sum" footerTemplate="مجموع عمولة الشحنات:(${Sum})"></e-aggregate-column>
                                            <e-aggregate-column field="ShipmentExtraFees" type="Sum" footerTemplate="مجموع العمولات الاضافية للشحنات:(${Sum})"></e-aggregate-column>
                                        </e-aggregate-columns>
                                    </e-grid-aggregate>
                                </e-grid-aggregates>
                                <e-grid-columns>
                                    <e-grid-column type="checkbox" width="50"></e-grid-column>

                                    <e-grid-column field="Id" headerText="Id" allowEditing="false" Visible="false" isPrimaryKey="true"></e-grid-column>
                                    <e-grid-column field="BusinessUserId" headerText="BusinessUserId" allowEditing="false" Visible="false"></e-grid-column>
                                    @*<e-grid-column field="CityCode" headerText="City Code" width="120"></e-grid-column>*@
                                    <e-grid-column field="ShipmentTrackingNo" headerText="رقم التتبع" width="120"></e-grid-column>
                                    <e-grid-column field="IUser" headerText="المدخل/المسوق" width="120"></e-grid-column>
                                    <e-grid-column field="ShipmentContains" headerText="محتويات الشحنة" width="120"></e-grid-column>
                                    <e-grid-column field="EntryDateTime" format="dd/MM/yyyy hh:mm" type="date" headerText="تاريخ الادخال" width="120"></e-grid-column>
                                    <e-grid-column field="ToCity" headerText="المدينة" width="120"></e-grid-column>
                                    <e-grid-column field="AreaName" headerText="المنطقة" width="120"></e-grid-column>
                                    <e-grid-column field="ShipmentTotal" headerText="المجموع الكلي" width="120"></e-grid-column>
                                    <e-grid-column field="ShipmentPrice" headerText="سعر الشحنة" width="120"></e-grid-column>
                                    <e-grid-column field="ShipmentFees" headerText="عمولة الشحنة" width="120"></e-grid-column>
                                    <e-grid-column field="ShipmentExtraFees" headerText="عمولات الشحنة الاضافية" width="120"></e-grid-column>
                                </e-grid-columns>
                            </ejs-grid>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
    <!-- /.content -->

</div>

<div id="pageOverlay" class="loading-overlay hidden">
    <div class="spinner"></div>
    <div class="loading-text">جاري معالجة الدفع...</div>
</div>

<script>
    function onfiltering(e) {
        var query = new ej.data.Query();
        query = (e.text !== '') ? query.where('Name', 'contains', e.text, true) : query;
        e.updateData(@Html.Raw(JsonConvert.SerializeObject(ViewBag.data)), query);
    }
    function showLoadingOverlay() {
        var overlay = document.getElementById('pageOverlay');
        if (overlay) {
            overlay.classList.remove('hidden');
            document.body.classList.add('no-scroll');
        }
    }
    function hideLoadingOverlay() {
        var overlay = document.getElementById('pageOverlay');
        if (overlay) {
            overlay.classList.add('hidden');
            document.body.classList.remove('no-scroll');
        }
    }
    function GetuserStmt() {
        var User = document.getElementById('User').ej2_instances[0];
        var grid1 = document.getElementById('Grid').ej2_instances[0]; // Grid instance

            var UserM = document.getElementById('UserM').ej2_instances[0]; // Grid instance
             UserM.value = null;
             UserM.dataSource = new ej.data.DataManager({
                url: '/AccountManagement/GetMBusnissUser?user=' + User.value,
                adaptor: new ej.data.UrlAdaptor()
            });



        grid1.dataSource = new ej.data.DataManager({
            url: '/AccountManagement/UrlDatasourceBusnissStatment?userId=' + User.value,
            adaptor: new ej.data.UrlAdaptor()
        });
        //$.ajax({
        //    type: "Get",
        //    url: "/Shipments/GetShipmentsTrackingGeneratedCode?UserId="+SenderName.value,
        //    data: ''
        //}).done(function (data) {
        //    var  obj = JSON.parse(JSON.stringify(data));

        //               $("#ShipmentTrackingNo").val(obj["GeneratedCode"]);
        //});

    }

    function GetuserStmt2() {
        var User = document.getElementById('User').ej2_instances[0];
        var grid1 = document.getElementById('Grid').ej2_instances[0]; // Grid instance
      var UserM = document.getElementById('UserM').ej2_instances[0]; // Grid instance



      if(UserM.value==null){

        grid1.dataSource = new ej.data.DataManager({
            url: '/AccountManagement/UrlDatasourceBusnissStatment?userId=' + User.value,
            adaptor: new ej.data.UrlAdaptor()
        });
      }else{

        grid1.dataSource = new ej.data.DataManager({
            url: '/AccountManagement/UrlDatasourceBusnissStatmentM?userId=' + User.value+'&MuserId='+UserM.value,
            adaptor: new ej.data.UrlAdaptor()
        });
      }

        //$.ajax({
        //    type: "Get",
        //    url: "/Shipments/GetShipmentsTrackingGeneratedCode?UserId="+SenderName.value,
        //    data: ''
        //}).done(function (data) {
        //    var  obj = JSON.parse(JSON.stringify(data));

        //               $("#ShipmentTrackingNo").val(obj["GeneratedCode"]);
        //});

    }
    function Refresh() {
        var User = document.getElementById('User').ej2_instances[0];
        var grid1 = document.getElementById('Grid').ej2_instances[0]; // Grid instance
        grid1.dataSource = new ej.data.DataManager({
            url: '/AccountManagement/UrlDatasourceBusnissStatment?userId=' + User.value,
            adaptor: new ej.data.UrlAdaptor()
        });
    }
    function ExportExcel() {
        var grid1 = document.getElementById('Grid').ej2_instances[0]; // Grid instance
        var exceldata = grid1.getSelectedRecords();
        if (exceldata == null) {
            grid1.excelExport();
        } else {
            var exportProperties = {
                dataSource: exceldata
            };
            grid1.excelExport(exportProperties);
        }
    }

    function print() {
        var grid1 = document.getElementById('Grid').ej2_instances[0]; // Grid instance
        grid1.print();
    }
    function pay() {
        var grid = document.getElementById('Grid').ej2_instances[0]; // Grid instance
        var InvoiceStatus = document.getElementById('InvoiceStatus').ej2_instances[0]; // Grid instance
        var selectedRecords = grid.getSelectedRecords();
        if (!selectedRecords || selectedRecords.length === 0) {
            swal("الرجاء اختيار الشحنات المراد دفعها");
            return;
        }
        if (InvoiceStatus.value == null) {
            swal("الرجاء اختيار السائق");
            return;
        }
        swal({
            title: "هل انت متأكد ؟",
            icon: "info",
            buttons: true,
            dangerMode: true,
        })
            .then((willDelete) => {
                if (willDelete) {
                    showLoadingOverlay();
                    document.getElementById("pay").disabled = true;
                     //alert(myJSON);
                    var ajax1 = new ej.base.Ajax({ url: '/AccountManagement/PayToBusniss?dariverID=' + InvoiceStatus.value, data: JSON.stringify(selectedRecords), type: 'POST', contentType: 'application/json' });
                    ajax1.send(JSON.stringify(selectedRecords));
                    ajax1.onSuccess = function (data) {
                        document.getElementById("pay").disabled = false;
                        hideLoadingOverlay();
                        swal(data, {
                            icon: "success",
                        });
                         var grid = document.getElementById("Grid").ej2_instances[0];
                        grid.refresh(); //tabObj.select(0);
                        window.open('/AccountManagement/PrintUserSlip?id=' + JSON.parse(data).Id, '_blank');
                    };
                    ajax1.onFailure = function (data) {
                        hideLoadingOverlay();
                        document.getElementById("pay").disabled = false;
                        swal(data);
                    };
                    ajax1.onError = function (error) {
                        hideLoadingOverlay();
                        document.getElementById("pay").disabled = false;
                        swal(error);
                    };
                } else {
                    //swal("Your imaginary file is safe!");
                }
            });
    }
    function rowSelected(args) {

        var shipRetCount = 0;
        var commSum = 0;
        var shipTotSum = 0;
        var total = 0;
        var ExtraFees = 0;
        $('#shipRetCount').text(shipRetCount);
        $('#commSum').text(commSum);
        $('#shipTotSum').text(shipTotSum);
        $('#total').text(total);
        $('#ExtraFees').text(ExtraFees);
        var grid = document.getElementById("Grid").ej2_instances[0];
        var selectedRecords = grid.getSelectedRecords();
        var ids = "";
        for (var k in selectedRecords) {
            commSum += selectedRecords[k].ShipmentFees;
            shipTotSum += selectedRecords[k].ShipmentTotal;
            ExtraFees += selectedRecords[k].ShipmentExtraFees;

        }
        $('#commSum').text(commSum);
        $('#shipRetCount').text(selectedRecords.length);
        $('#shipTotSum').text(shipTotSum);
        $('#total').text(shipTotSum - commSum - ExtraFees);
        $('#ExtraFees').text(ExtraFees);
    }


    function GetBus() {

        var User = document.getElementById('User').ej2_instances[0]; // Grid instance
        User.value = null;
        var CompanyBranches = document.getElementById('CompanyBranches').ej2_instances[0]; // Grid instance
        User.dataSource = new ej.data.DataManager({
            url: '/AccountManagement/GetBusnissUser?branchId=' + CompanyBranches.value,
            adaptor: new ej.data.UrlAdaptor()
        });
    }


    function recordClick() {


        timeout = setTimeout(alertFunc, 500);

    }

    function alertFunc() {
        var shipRetCount = 0;
        var commSum = 0;
        var shipTotSum = 0;
        var total = 0;
        var ExtraFees = 0;
        $('#shipRetCount').text(shipRetCount);
        $('#commSum').text(commSum);
        $('#shipTotSum').text(shipTotSum);
        $('#total').text(total);
        $('#ExtraFees').text(ExtraFees);
        var grid = document.getElementById("Grid").ej2_instances[0];
        var selectedRecords = grid.getSelectedRecords();
        var ids = "";
        for (var k in selectedRecords) {
            commSum += selectedRecords[k].ShipmentFees;
            shipTotSum += selectedRecords[k].ShipmentTotal;
            ExtraFees += selectedRecords[k].ShipmentExtraFees;
        }
        $('#commSum').text(commSum);
        $('#shipRetCount').text(selectedRecords.length);
        $('#shipTotSum').text(shipTotSum);
        $('#total').text(shipTotSum - commSum - ExtraFees);
        $('#ExtraFees').text(ExtraFees);
    }
</script>