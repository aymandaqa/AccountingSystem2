@model AccountingSystem.ViewModels.PagedResult<AccountingSystem.ViewModels.AssetExpenseListViewModel>
@{
    ViewData["Title"] = "مصاريف الأصول";
    var showMyExpenses = ViewBag.ShowMyExpenses as bool? ?? false;
    var pageSize = ViewBag.PageSize is int size && size > 0 ? size : 10;
    var totalItems = Model.TotalItems;
}

<div class="container-fluid">
    <div class="card">
        <div class="card-header d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-2">
            <div>
                <h3 class="card-title mb-0">مصاريف الأصول</h3>
                <small class="text-muted">إجمالي السجلات: @totalItems</small>
            </div>
            <div class="btn-group">
                <a asp-action="ExportExcel"
                   asp-route-searchTerm="@Model.SearchTerm"
                   asp-route-showMyExpenses="@showMyExpenses"
                   class="btn btn-success"
                   asp-require-permission="assetexpenses.view">
                    <i class="fas fa-file-excel me-1"></i> تصدير Excel
                </a>
                <a asp-action="Create"
                   class="btn btn-primary"
                   asp-require-permission="assetexpenses.create">
                    <i class="fas fa-plus"></i> إضافة مصروف
                </a>
            </div>
        </div>
        <div class="card-body">
            <form id="assetExpenseFilters" method="get" class="row g-3 align-items-end mb-4">
                <input type="hidden" name="page" value="1" />
                <input type="hidden" name="showMyExpenses" value="@showMyExpenses.ToString().ToLower()" />
                <div class="col-lg-6 col-md-7">
                    <label class="form-label" for="searchTerm">بحث</label>
                    <div class="input-group">
                        <input type="text"
                               class="form-control"
                               id="searchTerm"
                               name="searchTerm"
                               value="@Model.SearchTerm"
                               placeholder="ابحث باسم الأصل، الفرع، الحساب، المورد أو المستخدم" />
                        <button type="submit" class="btn btn-primary">بحث</button>
                    </div>
                </div>
                <div class="col-lg-3 col-md-5">
                    <label class="form-label" for="pageSize">عدد السجلات في الصفحة</label>
                    <select class="form-select" id="pageSize" name="pageSize">
                        @{
                            var pageSizeOptions = new[] { 10, 20, 50, 100 };
                            foreach (var option in pageSizeOptions)
                            {
                                var selected = option == pageSize ? "selected" : "";
                            }
                        }
                        @foreach (var option in pageSizeOptions)
                        {
                            <option value="@option" selected="@(option == pageSize ? "selected" : null)">@option</option>
                        }
                    </select>
                </div>
                <div class="col-lg-3 col-md-6">
                    <div class="form-check form-switch mt-4 pt-1">
                        <input class="form-check-input" type="checkbox" id="showMyExpensesSwitch" @(showMyExpenses ? "checked" : null) />
                        <label class="form-check-label" for="showMyExpensesSwitch">عرض مصاريفي فقط</label>
                    </div>
                </div>
            </form>

            @if (Model.Items.Any())
            {
                <div class="table-responsive">
                    <table class="table table-striped table-hover align-middle">
                        <thead class="table-dark">
                            <tr>
                                <th>الأصل</th>
                                <th>الفرع</th>
                                <th>الحساب</th>
                                <th>المورد</th>
                                <th>المستخدم المدخل</th>
                                <th>المستخدم المعتمد</th>
                                <th>المبلغ</th>
                                <th>نوع الدفع</th>
                                <th>التاريخ</th>
                                <th>ملاحظات</th>
                                <th>الحالة</th>
                                <th class="text-center">القيد المحاسبي</th>
                                <th class="text-center">الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in Model.Items)
                            {
                                <tr>
                                    <td><strong>@item.AssetName</strong></td>
                                    <td>@item.BranchName</td>
                                    <td>@item.ExpenseAccountName</td>
                                    <td>@item.SupplierName</td>
                                    <td>@(string.IsNullOrWhiteSpace(item.CreatedByName) ? "-" : item.CreatedByName)</td>
                                    <td>@(string.IsNullOrWhiteSpace(item.ApprovedByName) ? "-" : item.ApprovedByName)</td>
                                    <td>@item.Amount.ToString("N2")</td>
                                    <td>@(item.IsCash ? "نقدي" : "غير نقدي")</td>
                                    <td>@item.Date.ToString("dd/MM/yyyy")</td>
                                    <td>@(string.IsNullOrWhiteSpace(item.Notes) ? "-" : item.Notes)</td>
                                    <td>
                                        @switch (item.WorkflowStatus)
                                        {
                                            case AccountingSystem.Models.Workflows.WorkflowInstanceStatus.InProgress:
                                                <span class="badge bg-warning text-dark">قيد الاعتماد</span>
                                                break;
                                            case AccountingSystem.Models.Workflows.WorkflowInstanceStatus.Rejected:
                                                <span class="badge bg-danger">مرفوض</span>
                                                break;
                                            case AccountingSystem.Models.Workflows.WorkflowInstanceStatus.Cancelled:
                                                <span class="badge bg-secondary">ملغي</span>
                                                break;
                                            case AccountingSystem.Models.Workflows.WorkflowInstanceStatus.Approved:
                                                <span class="badge bg-success">معتمد</span>
                                                break;
                                            default:
                                                <span class="badge bg-success">معتمد</span>
                                                break;
                                        }
                                    </td>
                                    <td class="text-center">
                                        @if (item.JournalEntryId.HasValue)
                                        {
                                            <a asp-controller="JournalEntries"
                                               asp-action="Details"
                                               asp-route-id="@item.JournalEntryId.Value"
                                               asp-require-permission="journal.view"
                                               class="btn btn-sm btn-outline-primary"
                                               title="عرض القيد @item.JournalEntryNumber">
                                                <i class="fas fa-book-open"></i>
                                            </a>
                                        }
                                        else
                                        {
                                            <span class="text-muted">-</span>
                                        }
                                    </td>
                                    <td class="text-center">
                                        <form asp-action="Delete"
                                              asp-route-id="@item.Id"
                                              method="post"
                                              class="d-inline"
                                              asp-require-permission="assetexpenses.delete"
                                              onsubmit="return confirm('هل أنت متأكد من حذف مصروف الأصل؟');">
                                            <button type="submit" class="btn btn-sm btn-danger">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </form>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>

                if (Model.TotalPages > 1)
                {
                    <nav aria-label="Asset expenses pagination" class="mt-3">
                        <ul class="pagination justify-content-center mb-0">
                            @for (int i = 1; i <= Model.TotalPages; i++)
                            {
                                <li class="page-item @(i == Model.Page ? "active" : null)">
                                    <a class="page-link"
                                       href="@Url.Action("Index", new { page = i, pageSize, searchTerm = Model.SearchTerm, showMyExpenses })">
                                        @i
                                    </a>
                                </li>
                            }
                        </ul>
                    </nav>
                }
            }
            else
            {
                <div class="alert alert-info text-center">
                    لا توجد مصاريف مسجلة بالمعايير الحالية.
                </div>
            }
        </div>
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const form = document.getElementById('assetExpenseFilters');
            const pageSizeSelect = document.getElementById('pageSize');
            const showMyExpensesSwitch = document.getElementById('showMyExpensesSwitch');
            const showMyExpensesInput = form.querySelector('input[name="showMyExpenses"]');

            pageSizeSelect.addEventListener('change', function () {
                form.submit();
            });

            showMyExpensesSwitch.addEventListener('change', function () {
                showMyExpensesInput.value = this.checked ? 'true' : 'false';
                form.submit();
            });
        });
    </script>
}
