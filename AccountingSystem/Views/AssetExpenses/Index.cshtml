@model AccountingSystem.ViewModels.PagedResult<AccountingSystem.ViewModels.AssetExpenseListViewModel>
@{
    ViewData["Title"] = "مصاريف الأصول";
    var showMyExpenses = ViewBag.ShowMyExpenses as bool? ?? false;
    var pageSize = ViewBag.PageSize is int size && size > 0 ? size : 10;
    var totalItems = Model.TotalItems;
}

<div class="container-fluid">
    <div class="card shadow-sm">
        <div class="card-header bg-white py-3 d-flex flex-column flex-lg-row justify-content-between align-items-lg-center gap-3">
            <div>
                <h1 class="h4 mb-1">مصاريف الأصول</h1>
                <p class="text-muted mb-0">إجمالي السجلات: @totalItems</p>
            </div>
            <div class="d-flex flex-wrap gap-2">
                <a asp-action="ExportExcel"
                   asp-route-searchTerm="@Model.SearchTerm"
                   asp-route-showMyExpenses="@showMyExpenses"
                   class="btn btn-success"
                   asp-require-permission="assetexpenses.view">
                    <i class="fas fa-file-excel me-1"></i> تصدير Excel
                </a>
                <a asp-action="Create"
                   class="btn btn-primary"
                   asp-require-permission="assetexpenses.create">
                    <i class="fas fa-plus"></i> إضافة مصروف
                </a>
            </div>
        </div>
        <div class="card-body">
            <form id="assetExpenseFilters" method="get" class="row g-3 align-items-end mb-4">
                <input type="hidden" name="page" value="1" />
                <input type="hidden" name="showMyExpenses" value="@showMyExpenses.ToString().ToLower()" />
                <div class="col-12 col-md-6 col-lg-5">
                    <label class="form-label" for="searchTerm">بحث عام</label>
                    <div class="input-group">
                        <input type="text"
                               class="form-control"
                               id="searchTerm"
                               name="searchTerm"
                               value="@Model.SearchTerm"
                               placeholder="ابحث باسم الأصل، الفرع، الحساب، المورد أو المستخدم" />
                        <button type="submit" class="btn btn-primary"><i class="fas fa-search ms-1"></i> بحث</button>
                    </div>
                </div>
                <div class="col-6 col-md-3 col-lg-2">
                    <label class="form-label" for="pageSize">عدد السجلات</label>
                    <select class="form-select" id="pageSize" name="pageSize">
                        @foreach (var option in new[] { 10, 20, 50, 100 })
                        {
                            <option value="@option" selected="@(option == pageSize ? "selected" : null)">@option</option>
                        }
                    </select>
                </div>
                <div class="col-6 col-md-3 col-lg-2">
                    <label class="form-label" for="showMyExpensesSwitch">عرض مصاريفي</label>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="showMyExpensesSwitch" @(showMyExpenses ? "checked" : null) />
                        <label class="form-check-label" for="showMyExpensesSwitch">فقط</label>
                    </div>
                </div>
                <div class="col-12 col-lg-3 d-flex justify-content-lg-end gap-2">
                    <button type="submit" class="btn btn-secondary flex-grow-1 flex-lg-grow-0"><i class="fas fa-filter ms-1"></i> تطبيق</button>
                    <a asp-action="Index" class="btn btn-outline-secondary flex-grow-1 flex-lg-grow-0"><i class="fas fa-undo ms-1"></i> إعادة تعيين</a>
                </div>
            </form>

            @if (Model.Items.Any())
            {
                <div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-2">
                    <span class="text-muted small">يمكنك تصفية البيانات حسب كل عمود باستخدام المرشحات التالية.</span>
                    <button type="button" class="btn btn-sm btn-outline-secondary" id="asset-expenses-reset">
                        <i class="fas fa-eraser ms-1"></i> مسح مرشحات الجدول
                    </button>
                </div>

                <div class="table-responsive">
                    <table class="table table-striped table-hover align-middle" data-table-filter data-table-filter-reset="#asset-expenses-reset">
                        <thead class="table-light">
                            <tr>
                                <th scope="col">الأصل</th>
                                <th scope="col">الفرع</th>
                                <th scope="col">الحساب</th>
                                <th scope="col">المورد</th>
                                <th scope="col">المستخدم المدخل</th>
                                <th scope="col">المستخدم المعتمد</th>
                                <th scope="col">المبلغ</th>
                                <th scope="col">نوع الدفع</th>
                                <th scope="col">التاريخ</th>
                                <th scope="col">المرفق</th>
                                <th scope="col">ملاحظات</th>
                                <th scope="col">الحالة</th>
                                <th scope="col" class="text-center">القيد المحاسبي</th>
                                <th scope="col" class="text-center">الإجراءات</th>
                            </tr>
                            <tr class="table-secondary filters-row">
                                <th><input type="text" class="form-control form-control-sm" placeholder="بحث" data-filter-column="0" /></th>
                                <th><input type="text" class="form-control form-control-sm" placeholder="بحث" data-filter-column="1" /></th>
                                <th><input type="text" class="form-control form-control-sm" placeholder="بحث" data-filter-column="2" /></th>
                                <th><input type="text" class="form-control form-control-sm" placeholder="بحث" data-filter-column="3" /></th>
                                <th><input type="text" class="form-control form-control-sm" placeholder="بحث" data-filter-column="4" /></th>
                                <th><input type="text" class="form-control form-control-sm" placeholder="بحث" data-filter-column="5" /></th>
                                <th>
                                    <div class="d-flex gap-2">
                                        <input type="number" step="0.01" class="form-control form-control-sm" placeholder="من" data-filter-column="6" data-filter-type="number-min" />
                                        <input type="number" step="0.01" class="form-control form-control-sm" placeholder="إلى" data-filter-column="6" data-filter-type="number-max" />
                                    </div>
                                </th>
                                <th>
                                    <select class="form-select form-select-sm" data-filter-column="7" data-filter-type="select">
                                        <option value="">الكل</option>
                                        <option value="نقدي">نقدي</option>
                                        <option value="غير نقدي">غير نقدي</option>
                                    </select>
                                </th>
                                <th>
                                    <div class="d-flex gap-2">
                                        <input type="date" class="form-control form-control-sm" data-filter-column="8" data-filter-type="date-min" />
                                        <input type="date" class="form-control form-control-sm" data-filter-column="8" data-filter-type="date-max" />
                                    </div>
                                </th>
                                <th><input type="text" class="form-control form-control-sm" placeholder="بحث" data-filter-column="9" /></th>
                                <th><input type="text" class="form-control form-control-sm" placeholder="بحث" data-filter-column="10" /></th>
                                <th>
                                    <select class="form-select form-select-sm" data-filter-column="11" data-filter-type="select">
                                        <option value="">الكل</option>
                                        <option value="قيد الاعتماد">قيد الاعتماد</option>
                                        <option value="مرفوض">مرفوض</option>
                                        <option value="ملغي">ملغي</option>
                                        <option value="معتمد">معتمد</option>
                                    </select>
                                </th>
                                <th></th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in Model.Items)
                            {
                                var workflowStatusText = item.WorkflowStatus switch
                                {
                                    AccountingSystem.Models.Workflows.WorkflowInstanceStatus.InProgress => "قيد الاعتماد",
                                    AccountingSystem.Models.Workflows.WorkflowInstanceStatus.Rejected => "مرفوض",
                                    AccountingSystem.Models.Workflows.WorkflowInstanceStatus.Cancelled => "ملغي",
                                    AccountingSystem.Models.Workflows.WorkflowInstanceStatus.Approved => "معتمد",
                                    _ => "معتمد"
                                };

                                <tr>
                                    <td data-filter-value="@item.AssetName"><strong>@item.AssetName</strong></td>
                                    <td data-filter-value="@item.BranchName">@item.BranchName</td>
                                    <td data-filter-value="@item.ExpenseAccountName">@item.ExpenseAccountName</td>
                                    <td data-filter-value="@item.SupplierName">@item.SupplierName</td>
                                    <td data-filter-value="@item.CreatedByName">@(string.IsNullOrWhiteSpace(item.CreatedByName) ? "-" : item.CreatedByName)</td>
                                    <td data-filter-value="@item.ApprovedByName">@(string.IsNullOrWhiteSpace(item.ApprovedByName) ? "-" : item.ApprovedByName)</td>
                                    <td data-filter-numeric="@item.Amount" class="text-nowrap">@item.Amount.ToString("N2")</td>
                                    <td data-filter-value="@(item.IsCash ? "نقدي" : "غير نقدي")">@(item.IsCash ? "نقدي" : "غير نقدي")</td>
                                    <td data-filter-date="@item.Date.ToString("yyyy-MM-dd")" class="text-nowrap">@item.Date.ToString("dd/MM/yyyy")</td>
                                    <td data-filter-value="@(string.IsNullOrWhiteSpace(item.AttachmentFileName) ? "-" : item.AttachmentFileName)">
                                        @if (!string.IsNullOrWhiteSpace(item.AttachmentFilePath))
                                        {
                                            <a href="@Url.ContentFromAttachmentPath(item.AttachmentFilePath)" target="_blank" rel="noopener">
                                                @(string.IsNullOrWhiteSpace(item.AttachmentFileName) ? "عرض" : item.AttachmentFileName)
                                            </a>
                                        }
                                        else
                                        {
                                            <span class="text-muted">-</span>
                                        }
                                    </td>
                                    <td data-filter-value="@(string.IsNullOrWhiteSpace(item.Notes) ? "-" : item.Notes)">@(string.IsNullOrWhiteSpace(item.Notes) ? "-" : item.Notes)</td>
                                    <td data-filter-value="@workflowStatusText">
                                        @switch (item.WorkflowStatus)
                                        {
                                            case AccountingSystem.Models.Workflows.WorkflowInstanceStatus.InProgress:
                                                <span class="badge bg-warning text-dark">قيد الاعتماد</span>
                                                break;
                                            case AccountingSystem.Models.Workflows.WorkflowInstanceStatus.Rejected:
                                                <span class="badge bg-danger">مرفوض</span>
                                                break;
                                            case AccountingSystem.Models.Workflows.WorkflowInstanceStatus.Cancelled:
                                                <span class="badge bg-secondary">ملغي</span>
                                                break;
                                            case AccountingSystem.Models.Workflows.WorkflowInstanceStatus.Approved:
                                                <span class="badge bg-success">معتمد</span>
                                                break;
                                            default:
                                                <span class="badge bg-success">معتمد</span>
                                                break;
                                        }
                                    </td>
                                    <td class="text-center" data-filter-value="@item.JournalEntryNumber">
                                        @if (item.JournalEntryId.HasValue)
                                        {
                                            <a asp-controller="JournalEntries"
                                               asp-action="Details"
                                               asp-route-id="@item.JournalEntryId.Value"
                                               asp-require-permission="journal.view"
                                               class="btn btn-sm btn-outline-primary"
                                               title="عرض القيد @item.JournalEntryNumber">
                                                <i class="fas fa-book-open"></i>
                                            </a>
                                        }
                                        else
                                        {
                                            <span class="text-muted">-</span>
                                        }
                                    </td>
                                    <td class="text-center">
                                        <form asp-action="Delete"
                                              asp-route-id="@item.Id"
                                              method="post"
                                              class="d-inline"
                                              asp-require-permission="assetexpenses.delete"
                                              onsubmit="return confirm('هل أنت متأكد من حذف مصروف الأصل؟');">
                                            <button type="submit" class="btn btn-sm btn-danger">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </form>
                                    </td>
                                </tr>
                            }
                            <tr class="no-results d-none">
                                <td colspan="14" class="text-center text-muted">لا توجد نتائج مطابقة للمرشحات الحالية.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                if (Model.TotalPages > 1)
                {
                    <nav aria-label="Asset expenses pagination" class="mt-3">
                        <ul class="pagination justify-content-center mb-0">
                            @for (int i = 1; i <= Model.TotalPages; i++)
                            {
                                <li class="page-item @(i == Model.Page ? "active" : null)">
                                    <a class="page-link"
                                       href="@Url.Action("Index", new { page = i, pageSize, searchTerm = Model.SearchTerm, showMyExpenses })">
                                        @i
                                    </a>
                                </li>
                            }
                        </ul>
                    </nav>
                }
            }
            else
            {
                <div class="alert alert-info text-center">
                    لا توجد مصاريف مسجلة بالمعايير الحالية.
                </div>
            }
        </div>
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const form = document.getElementById('assetExpenseFilters');
            const pageSizeSelect = document.getElementById('pageSize');
            const showMyExpensesSwitch = document.getElementById('showMyExpensesSwitch');
            const showMyExpensesInput = form.querySelector('input[name="showMyExpenses"]');

            pageSizeSelect.addEventListener('change', function () {
                form.submit();
            });

            showMyExpensesSwitch.addEventListener('change', function () {
                showMyExpensesInput.value = this.checked ? 'true' : 'false';
                form.submit();
            });
        });
    </script>
    <script src="~/js/table-filters.js" asp-append-version="true"></script>
}
