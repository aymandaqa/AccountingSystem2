@model TrialBalanceViewModel
@using AccountingSystem.ViewModels
@using System.Linq

@{
    ViewData["Title"] = "ميزان المراجعة";
    var hasMismatch = Model.Accounts.Any(a => a.DebitBalance != 0 && a.CreditBalance != 0);
}

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title mb-0">
                        <i class="fas fa-balance-scale me-2"></i>
                        ميزان المراجعة
                    </h3>
                </div>
                <div class="card-body">
                    <!-- فلاتر التقرير -->
                    <form method="get" class="row g-3 mb-4">
                        <div class="col-md-3">
                            <label class="form-label">من تاريخ:</label>
                            <input type="date" name="fromDate" class="form-control" value="@Model.FromDate.ToString("yyyy-MM-dd")" />
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">إلى تاريخ:</label>
                            <input type="date" name="toDate" class="form-control" value="@Model.ToDate.ToString("yyyy-MM-dd")" />
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">العملة:</label>
                            <select name="currencyId" class="form-select">
                                @foreach (var currency in Model.Currencies)
                                {
                                    var isSelected = currency.Value == Model.SelectedCurrencyId?.ToString();
                                    if (isSelected)
                                    {
                                        <option value="@currency.Value" selected>@currency.Text</option>
                                    }
                                    else
                                    {
                                        <option value="@currency.Value">@currency.Text</option>
                                    }
                                }
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">المستوى:</label>
                            <select name="level" class="form-select">
                                @foreach (var level in Model.Levels)
                                {
                                    if (level.Selected)
                                    {
                                        <option value="@level.Value" selected>@level.Text</option>
                                    }
                                    else
                                    {
                                        <option value="@level.Value">@level.Text</option>
                                    }
                                }
                            </select>
                        </div>
                        <div class="col-md-3 d-flex align-items-end">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="includePending" value="true" @(Model.IncludePending ? "checked" : "") />
                                <label class="form-check-label">شمل القيود غير المرحلة</label>
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="d-flex flex-wrap gap-2">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-search me-1"></i>
                                    عرض التقرير
                                </button>
                                <a class="btn btn-success" asp-action="TrialBalanceExcel"
                                   asp-route-fromDate='@Model.FromDate.ToString("yyyy-MM-dd")'
                                   asp-route-toDate='@Model.ToDate.ToString("yyyy-MM-dd")'
                                   asp-route-includePending='@Model.IncludePending'
                                   asp-route-currencyId='@Model.SelectedCurrencyId'
                                   asp-route-level='@Model.SelectedLevel'>
                                    <i class="fas fa-file-excel me-1"></i>
                                    تصدير Excel
                                </a>
                            </div>
                        </div>
                    </form>

                    <!-- جدول التقرير -->
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>رمز الحساب</th>
                                    <th>اسم الحساب</th>
                                    <th>المستوى</th>
                                    <th>الرصيد المدين (@Model.SelectedCurrencyCode)</th>
                                    <th>الرصيد الدائن (@Model.SelectedCurrencyCode)</th>
                                    <th>الرصيد المدين (@Model.BaseCurrencyCode)</th>
                                    <th>الرصيد الدائن (@Model.BaseCurrencyCode)</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var account in Model.Accounts)
                                {
                                    var isMismatch = account.DebitBalance != 0 && account.CreditBalance != 0;
                                    <tr class="@(isMismatch ? "table-danger" : string.Empty)">
                                        <td>@account.AccountCode</td>
                                        <td class="text-nowrap">
                                            <span style="display:inline-block; padding-right:@((account.Level - 1) * 1.5)rem"></span>
                                            @account.AccountName
                                        </td>
                                        <td>@account.Level</td>
                                        <td>@account.DebitBalance.ToString("N2")</td>
                                        <td>@account.CreditBalance.ToString("N2")</td>
                                        <td>@account.DebitBalanceBase.ToString("N2")</td>
                                        <td>@account.CreditBalanceBase.ToString("N2")</td>
                                    </tr>
                                }
                            </tbody>
                            <tfoot class="@(Model.TotalDebits == Model.TotalCredits ? "table-secondary" : "table-danger")">
                                <tr>
                                    <th colspan="3">الإجمالي</th>
                                    <th>@Model.TotalDebits.ToString("N2")</th>
                                    <th>@Model.TotalCredits.ToString("N2")</th>
                                    <th>@Model.TotalDebitsBase.ToString("N2")</th>
                                    <th>@Model.TotalCreditsBase.ToString("N2")</th>
                                </tr>
                            </tfoot>
                        </table>
                    </div>

                    @if (hasMismatch)
                    {
                        <div class="alert alert-danger mt-3">
                            توجد قيود غير متطابقة تم تمييزها باللون الأحمر.
                        </div>
                    }

                    <!-- معلومات إضافية -->
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <div class="alert alert-info">
                                <strong>الفترة:</strong> من @Model.FromDate.ToString("dd-MM-yyyy") إلى @Model.ToDate.ToString("dd-MM-yyyy")
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="alert @(Model.TotalDebits == Model.TotalCredits ? "alert-success" : "alert-danger")">
                                <strong>حالة التوازن:</strong>
                                @if (Model.TotalDebits == Model.TotalCredits)
                                {
                                    <span>متوازن ✓</span>
                                }
                                else
                                {
                                    <span>غير متوازن ✗</span>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
