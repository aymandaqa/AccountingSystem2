@model IEnumerable<AccountingSystem.ViewModels.AccountTreeNodeViewModel>
@using AccountingSystem.Models
@{
    var selectedCurrencyCode = ViewData["SelectedCurrencyCode"] as string ?? string.Empty;
}

@foreach (var node in Model.OrderBy(n => n.Code))
{
    var level = node.Level;
    var indent = Math.Max(0, (level - 1) * 18);
    var hasChildren = node.Children.Any();
    var isRoot = node.ParentId == null;
    var rowClass = isRoot ? "bs-row-root" : hasChildren ? "bs-row-group" : "bs-row-leaf";
    var nodeId = node.Id.ToString();
    var parentId = node.ParentId?.ToString() ?? string.Empty;
    decimal displayBalance;

    if (node.Nature == AccountNature.Credit)
    {
        displayBalance = node.BalanceSelected < 0
            ? Math.Abs(node.BalanceSelected)
            : -Math.Abs(node.BalanceSelected);
    }
    else if (node.Nature == AccountNature.Debit)
    {
        displayBalance = node.BalanceSelected > 0
            ? Math.Abs(node.BalanceSelected)
            : -Math.Abs(node.BalanceSelected);
    }
    else
    {
        displayBalance = node.BalanceSelected;
    }

    <tr class="balance-sheet-row @rowClass"
        data-level="@level"
        data-node-id="@nodeId"
        data-parent-id="@parentId"
        data-has-children="@hasChildren.ToString().ToLowerInvariant()">
        <td>
            <div class="balance-sheet-label" style="margin-right:@(indent)px;">
                @if (hasChildren)
                {
                    <button type="button"
                            class="balance-toggle"
                            data-node-id="@nodeId"
                            aria-label="تبديل عرض الحساب"
                            aria-expanded="true">
                        <i class="fas fa-minus-square"></i>
                    </button>
                }
                else
                {
                    <span class="balance-toggle-placeholder"></span>
                }

                @if (!string.IsNullOrWhiteSpace(node.Code))
                {
                    <span class="account-code">@node.Code</span>
                }
                <span class="account-name">@node.NameAr</span>
                @if (!string.IsNullOrWhiteSpace(node.CurrencyCode))
                {
                    <span class="account-currency text-muted">(@node.CurrencyCode)</span>
                }
            </div>
        </td>
        <td class="text-end">
            <span class="amount">@displayBalance.ToString("N2")</span>
            <span class="currency text-muted">@selectedCurrencyCode</span>
        </td>
    </tr>

    if (hasChildren)
    {
        @await Html.PartialAsync("_AccountBalanceTableRows", node.Children.OrderBy(c => c.Code))
    }
}
