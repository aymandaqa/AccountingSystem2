@{
    ViewData["Title"] = "أرصدة الموردين";
    var rtl = true;
}

<div class="container-full">
    <section class="content">
        <div class="row">
            <div class="col-12">
                <div class="box">
                    <div class="box-body">
                        <div class="row align-items-end mb-3">
                            <div class="col-md-3 col-sm-6 mb-3 mb-md-0">
                                <label class="form-label">الفرع</label>
                                <ejs-dropdownlist id="BranchFilter" name="BranchFilter" dataSource="@ViewBag.CompanyBranches" placeholder="اختيار الفرع" change="refreshGrid"
                                                  allowFiltering="true" filterType="Contains">
                                    <e-dropdownlist-fields text="BranchName" value="Id"></e-dropdownlist-fields>
                                </ejs-dropdownlist>
                            </div>
                            <div class="col-md-3 col-sm-6 mb-3 mb-md-0">
                                <label class="form-label">المورد</label>
                                <ejs-dropdownlist id="SupplierFilter" name="SupplierFilter" dataSource="@ViewBag.Suppliers" placeholder="اختيار المورد" change="refreshGrid"
                                                  allowFiltering="true" filterType="Contains" popupHeight="300px">
                                    <e-dropdownlist-fields text="Name" value="Value"></e-dropdownlist-fields>
                                </ejs-dropdownlist>
                            </div>
                            <div class="col-md-6 text-start text-md-end">
                                <button class="btn btn-primary me-2" type="button" onclick="exportExcel()"><i class="ti-layout"></i> تصدير اكسل</button>
                                <button class="btn btn-secondary" type="button" onclick="resetFilters()"><i class="ti-reload"></i> إعادة تعيين</button>
                            </div>
                        </div>

                        <ejs-grid id="SupplierGrid" allowFiltering="true" allowSorting="true" allowPaging="true" allowExcelExport="true"
                                  gridLines="Both" enableRtl="@rtl" height="450px" allowTextWrap="true">
                            <e-data-manager url="/Reports/UrlDatasourceSupplierBalances" adaptor="UrlAdaptor"></e-data-manager>
                            <e-grid-filterSettings type="Excel"></e-grid-filterSettings>
                            <e-grid-pagesettings pageSize="20" pageSizes="true"></e-grid-pagesettings>
                            <e-grid-aggregates>
                                <e-grid-aggregate>
                                    <e-aggregate-columns>
                                        <e-aggregate-column field="ShipmentsNumber" type="Sum" footerTemplate="إجمالي الشحنات: ${Sum}"></e-aggregate-column>
                                        <e-aggregate-column field="ShipmentPrice" type="Sum" footerTemplate="إجمالي مبالغ الشحن: ${Sum}"></e-aggregate-column>
                                        <e-aggregate-column field="AccountBalance" type="Sum" footerTemplate="إجمالي أرصدة الحساب: ${Sum}"></e-aggregate-column>
                                        <e-aggregate-column field="BalanceDifference" type="Sum" footerTemplate="إجمالي فرق الرصيد: ${Sum}"></e-aggregate-column>
                                    </e-aggregate-columns>
                                </e-grid-aggregate>
                            </e-grid-aggregates>
                            <e-grid-columns>
                                <e-grid-column field="SenderName" headerText="المورد" width="150"></e-grid-column>
                                <e-grid-column field="ShipmentsNumber" headerText="عدد الشحنات" width="120" textAlign="Right"></e-grid-column>
                                <e-grid-column field="ShipmentPrice" headerText="رصيد الشحنات" width="140" format="N2" textAlign="Right"></e-grid-column>
                                <e-grid-column field="BranchName" headerText="الفرع" width="130"></e-grid-column>
                                <e-grid-column field="AccountName" headerText="اسم الحساب" width="180"></e-grid-column>
                                <e-grid-column field="AccountBalance" headerText="رصيد الحساب" width="140" format="N2" textAlign="Right"></e-grid-column>
                                <e-grid-column field="BalanceDifference" headerText="فرق الرصيد" width="140" format="N2" textAlign="Right"></e-grid-column>
                                <e-grid-column headerText="العمليات" width="220" template="#actionsTemplate"></e-grid-column>
                                <e-grid-column field="SenderId" visible="false"></e-grid-column>
                                <e-grid-column field="AccountId" visible="false"></e-grid-column>
                            </e-grid-columns>
                        </ejs-grid>
                    </div>
                </div>
            </div>
        </div>
    </section>
</div>


<script id="actionsTemplate" type="text/x-template">
    <div class="btn-group" role="group">
        ${if (HasShipments)}
        <button class="btn btn-outline-primary btn-sm btn-open-shipments" type="button" data-sender-id="${SenderId}" data-sender-name="${SenderName}"><i class="ti-truck"></i> عرض الشحنات</button>
        ${/if}
        ${if (AccountId)}
        <a class="btn btn-outline-success btn-sm" target="_blank" href="/Reports/AccountStatement?accountId=${AccountId}&lockAccount=true"><i class="ti-clipboard"></i> كشف حساب</a>
        ${/if}
    </div>
</script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        refreshGrid();

        var supplierGrid = document.getElementById('SupplierGrid');
        if (supplierGrid) {
            supplierGrid.addEventListener('click', function (event) {
                var actionButton = event.target.closest('.btn-open-shipments');
                if (actionButton) {
                    event.preventDefault();
                    openShipments(actionButton);
                }
            });
        }
    });

    function getFilters() {
        var branchDropdown = document.getElementById('BranchFilter').ej2_instances[0];
        var supplierDropdown = document.getElementById('SupplierFilter').ej2_instances[0];

        return {
            branchId: branchDropdown.value || '',
            supplierKey: supplierDropdown.value || ''
        };
    }

    function refreshGrid() {
        var filters = getFilters();
        var grid = document.getElementById('SupplierGrid').ej2_instances[0];

        grid.dataSource = new ej.data.DataManager({
            url: '/Reports/UrlDatasourceSupplierBalances?branchId=' + filters.branchId + '&supplierKey=' + filters.supplierKey,
            adaptor: new ej.data.UrlAdaptor()
        });
        grid.refresh();
    }

    function resetFilters() {
        var branchDropdown = document.getElementById('BranchFilter').ej2_instances[0];
        var supplierDropdown = document.getElementById('SupplierFilter').ej2_instances[0];

        branchDropdown.value = null;
        supplierDropdown.value = null;

        refreshGrid();
    }

    function exportExcel() {
        var grid = document.getElementById('SupplierGrid').ej2_instances[0];
        grid.excelExport();
    }

    function openShipments(button) {
        var senderId = button.getAttribute('data-sender-id');
        var senderName = button.getAttribute('data-sender-name') || '';
        var modalTitle = document.getElementById('shipmentsModalLabel');
        modalTitle.textContent = 'شحنات ' + senderName;

        var grid = document.getElementById('ShipmentsGrid').ej2_instances[0];
        grid.dataSource = new ej.data.DataManager({
            url: '/Reports/UrlDatasourceSupplierShipments?senderId=' + senderId,
            adaptor: new ej.data.UrlAdaptor()
        });
        grid.refresh();
        var modalElement = document.getElementById('shipmentsModal');
        var modal = bootstrap.Modal.getOrCreateInstance(modalElement);
        modal.show();
    }
</script>
