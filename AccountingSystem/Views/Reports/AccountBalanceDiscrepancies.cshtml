@model AccountingSystem.ViewModels.AccountBalanceDiscrepancyViewModel
@using AccountingSystem.Models
@using System.Globalization
@{
    ViewData["Title"] = "فروقات أرصدة الحسابات";
    var generatedAt = Model.GeneratedAt.ToString("yyyy/MM/dd HH:mm", CultureInfo.InvariantCulture);
}

<div class="container-fluid">
    <div class="card shadow-sm">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h3 class="card-title mb-0">
                <i class="fas fa-balance-scale-left text-danger me-2"></i>
                تقرير فروقات أرصدة الحسابات
            </h3>
            <span class="text-muted small">
                <i class="far fa-clock me-1"></i>
                آخر تحديث: @generatedAt
            </span>
        </div>
        <div class="card-body">
            <div class="alert alert-info">
                <div class="d-flex align-items-center">
                    <i class="fas fa-info-circle fa-lg me-2"></i>
                    <div>
                        يعرض هذا التقرير الحسابات التي يختلف رصيدها الحالي المخزن عن الرصيد المحسوب من القيود المرحلة.
                        يتم حساب الرصيد المحسوب ببدءاً من الرصيد الافتتاحي مع صافي أثر القيود المرحلة وفق طبيعة الحساب
                        (مدين/دائن). يمكن استخدام زر "عرض القيود" لعرض القيود المؤثرة على الحساب.
                    </div>
                </div>
            </div>

            @if (!Model.Accounts.Any())
            {
                <div class="alert alert-success mb-0">
                    <i class="fas fa-check-circle me-2"></i>
                    لا توجد فروقات بين أرصدة الحسابات والقيود المرحلة.
                </div>
            }
            else
            {
                <div class="row g-3 mb-4">
                    <div class="col-sm-6 col-lg-3">
                        <div class="border rounded p-3 h-100 text-center">
                            <div class="text-muted small">عدد الحسابات المتأثرة</div>
                            <div class="fw-bold display-6">@Model.Accounts.Count</div>
                        </div>
                    </div>
                    <div class="col-sm-6 col-lg-3">
                        <div class="border rounded p-3 h-100 text-center">
                            <div class="text-muted small">إجمالي الأرصدة الحالية</div>
                            <div class="fw-bold fs-4">@Model.TotalCurrentBalance.ToString("N2")</div>
                        </div>
                    </div>
                    <div class="col-sm-6 col-lg-3">
                        <div class="border rounded p-3 h-100 text-center">
                            <div class="text-muted small">إجمالي أرصدة القيود</div>
                            <div class="fw-bold fs-4">@Model.TotalLedgerBalance.ToString("N2")</div>
                        </div>
                    </div>
                    <div class="col-sm-6 col-lg-3">
                        <div class="border rounded p-3 h-100 text-center">
                            <div class="text-muted small">إجمالي الفرق (قيمة مطلقة)</div>
                            <div class="fw-bold fs-4 text-danger">@Model.TotalAbsoluteDifference.ToString("N2")</div>
                        </div>
                    </div>
                </div>

                <div class="table-responsive">
                    <table class="table table-striped table-hover align-middle">
                        <thead class="table-light">
                            <tr>
                                <th>#</th>
                                <th>الحساب</th>
                                <th>طبيعة الحساب</th>
                                <th class="text-end">الرصيد الحالي</th>
                                <th class="text-end">رصيد القيود</th>
                                <th class="text-end">الفرق</th>
                                <th class="text-end">الرصيد الافتتاحي</th>
                                <th>القيود</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in Model.Accounts.Select((account, index) => new { Account = account, Index = index + 1 }))
                            {
                                var account = item.Account;
                                var rowIndex = item.Index;
                                var collapseId = $"account-discrepancy-{account.AccountId}";
                                var diffClass = account.Difference > 0 ? "text-danger" : "text-success";
                                var natureText = account.Nature == AccountNature.Debit ? "مدين" : "دائن";

                                <tr>
                                    <td>@rowIndex</td>
                                    <td>
                                        <div class="fw-bold">@account.AccountCode</div>
                                        <div class="text-muted small">@account.AccountName</div>
                                    </td>
                                    <td>@natureText</td>
                                    <td class="text-end">@account.CurrentBalance.ToString("N2")</td>
                                    <td class="text-end">@account.LedgerBalance.ToString("N2")</td>
                                    <td class="text-end fw-bold @diffClass">@account.Difference.ToString("N2")</td>
                                    <td class="text-end">@account.OpeningBalance.ToString("N2")</td>
                                    <td>
                                        <button class="btn btn-outline-primary btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#@collapseId" aria-expanded="false" aria-controls="@collapseId">
                                            <i class="fas fa-list me-1"></i>
                                            عرض القيود
                                        </button>
                                    </td>
                                </tr>
                                <tr class="collapse bg-light" id="@collapseId">
                                    <td colspan="8">
                                        <div class="p-3 border rounded">
                                            <h6 class="fw-bold mb-3">
                                                القيود المرحلة المرتبطة بالحساب
                                            </h6>
                                            <div class="table-responsive">
                                                <table class="table table-sm table-bordered mb-0">
                                                    <thead class="table-secondary">
                                                        <tr>
                                                            <th class="text-nowrap">التاريخ</th>
                                                            <th>رقم القيد</th>
                                                            <th>الوصف</th>
                                                            <th>المرجع</th>
                                                            <th class="text-end">مدين</th>
                                                            <th class="text-end">دائن</th>
                                                            <th class="text-end">الأثر الصافي</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        @if (!account.Entries.Any())
                                                        {
                                                            <tr>
                                                                <td colspan="7" class="text-center text-muted">لا توجد قيود مرحلة لهذا الحساب.</td>
                                                            </tr>
                                                        }
                                                        else
                                                        {
                                                            foreach (var entry in account.Entries)
                                                            {
                                                                var impactClass = entry.NetImpact >= 0 ? "text-success" : "text-danger";
                                                                <tr>
                                                                    <td class="text-nowrap">@entry.Date.ToString("yyyy/MM/dd")</td>
                                                                    <td>
                                                                        <a asp-controller="JournalEntries" asp-action="Details" asp-route-id="@entry.JournalEntryId" class="text-decoration-none">
                                                                            @entry.JournalNumber
                                                                        </a>
                                                                    </td>
                                                                    <td>@entry.Description</td>
                                                                    <td>@entry.Reference</td>
                                                                    <td class="text-end">@entry.Debit.ToString("N2")</td>
                                                                    <td class="text-end">@entry.Credit.ToString("N2")</td>
                                                                    <td class="text-end fw-bold @impactClass">@entry.NetImpact.ToString("N2")</td>
                                                                </tr>
                                                            }
                                                        }
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
        </div>
    </div>
</div>
