@model IEnumerable<AccountingSystem.ViewModels.Workflows.WorkflowApprovalViewModel>
@{
    ViewData["Title"] = "الموافقات المعلقة";
    var pendingRequests = Model.ToList();
    var groupedByUser = pendingRequests
        .GroupBy(request => string.IsNullOrWhiteSpace(request.CreatedByName) ? "غير معروف" : request.CreatedByName)
        .OrderBy(group => group.Key)
        .ToList();
    var userAccordionId = "workflow-approvals-users";
}

<h2 class="mb-4">الموافقات المعلقة</h2>

@if (TempData["Success"] != null)
{
    <div class="alert alert-success">@TempData["Success"]</div>
}
@if (TempData["Error"] != null)
{
    <div class="alert alert-danger">@TempData["Error"]</div>
}

@if (!pendingRequests.Any())
{
    <div class="alert alert-info">لا توجد أي طلبات موافقة حالياً.</div>
}
else
{
    <div class="accordion" id="@userAccordionId">
        @{
            var userIndex = 0;
        }
        @foreach (var userGroup in groupedByUser)
        {
            var userCollapseId = $"{userAccordionId}-collapse-{userIndex}";
            var userHeadingId = $"{userAccordionId}-heading-{userIndex}";
            var typeAccordionId = $"{userAccordionId}-types-{userIndex}";
            var typeGroups = userGroup
            .GroupBy(request => string.IsNullOrWhiteSpace(request.OperationTypeName) ? "أخرى" : request.OperationTypeName)
            .OrderBy(group => group.Key)
            .ToList();
            <div class="accordion-item mb-3">
                <h2 class="accordion-header" id="@userHeadingId">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#@userCollapseId" aria-expanded="false" aria-controls="@userCollapseId">
                        <span class="fw-semibold">@userGroup.Key</span>
                        <span class="badge bg-primary rounded-pill ms-2">@userGroup.Count()</span>
                    </button>
                </h2>
                <div id="@userCollapseId" class="accordion-collapse collapse" aria-labelledby="@userHeadingId" data-bs-parent="#@userAccordionId">
                    <div class="accordion-body">
                        <div class="accordion accordion-flush" id="@typeAccordionId">
                            @{
                                var typeIndex = 0;
                            }
                            @foreach (var typeGroup in typeGroups)
                            {
                                var typeCollapseId = $"{typeAccordionId}-collapse-{typeIndex}";
                                var typeHeadingId = $"{typeAccordionId}-heading-{typeIndex}";
                                <div class="accordion-item">
                                    <h2 class="accordion-header" id="@typeHeadingId">
                                        <button class="accordion-button collapsed py-2" type="button" data-bs-toggle="collapse" data-bs-target="#@typeCollapseId" aria-expanded="false" aria-controls="@typeCollapseId">
                                            <span class="fw-semibold">@typeGroup.Key</span>
                                            <span class="badge bg-secondary rounded-pill ms-2">@typeGroup.Count()</span>
                                        </button>
                                    </h2>
                                    <div id="@typeCollapseId" class="accordion-collapse collapse" aria-labelledby="@typeHeadingId" data-bs-parent="#@typeAccordionId">
                                        <div class="accordion-body">
                                            <div class="table-responsive">
                                                <table class="table table-hover align-middle mb-0">
                                                    <thead class="table-light">
                                                        <tr>
                                                            <th scope="col">عنوان الطلب</th>
                                                            <th scope="col">تاريخ الإنشاء</th>
                                                            <th scope="col" class="text-end">المبلغ</th>
                                                            <th scope="col">العملة</th>
                                                            <th scope="col" class="text-end">إجراءات</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        @foreach (var request in typeGroup.OrderByDescending(r => r.CreatedAt))
                                                        {
                                                            var detailId = $"request-details-{request.ActionId}";
                                                            <tr>
                                                                <td>
                                                                    <div class="fw-semibold">@request.Title</div>
                                                                    <div class="text-muted small">@request.Description</div>
                                                                </td>
                                                                <td class="text-nowrap">@request.CreatedAt.ToString("dd/MM/yyyy HH:mm")</td>
                                                                <td class="text-end">@request.Amount.ToString("N2")</td>
                                                                <td>@(string.IsNullOrWhiteSpace(request.CurrencyCode) ? "-" : request.CurrencyCode)</td>
                                                                <td>
                                                                    <div class="d-flex flex-wrap gap-1 justify-content-end">
                                                                        <button class="btn btn-success btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#approve-@request.ActionId" aria-expanded="false" aria-controls="approve-@request.ActionId">
                                                                            <i class="fa fa-check ms-1"></i> موافقة
                                                                        </button>
                                                                        <button class="btn btn-outline-primary btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#@detailId" aria-expanded="false" aria-controls="@detailId">
                                                                            <i class="fa fa-info-circle ms-1"></i> تفاصيل الطلب
                                                                        </button>
                                                                    </div>
                                                                </td>
                                                            </tr>
                                                            <tr>
                                                                <td colspan="5" class="p-0">
                                                                    <div class="collapse" id="approve-@request.ActionId" data-bs-parent="#@typeCollapseId">
                                                                        <div class="card rounded-0 border-top">
                                                                            <div class="card-body">
                                                                                <form asp-action="Approve" method="post">
                                                                                    @Html.AntiForgeryToken()
                                                                                    <input type="hidden" name="actionId" value="@request.ActionId" />
                                                                                    <div class="mb-3">
                                                                                        <label class="form-label">ملاحظات المدقق (اختيارية)</label>
                                                                                        <textarea name="notes" class="form-control" rows="3" placeholder="أدخل ملاحظاتك إن وجدت"></textarea>
                                                                                    </div>
                                                                                    <button type="submit" class="btn btn-success">
                                                                                        <i class="fa fa-check ms-1"></i> تأكيد الموافقة
                                                                                    </button>
                                                                                </form>
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                </td>
                                                            </tr>
                                                            <tr>
                                                                <td colspan="5" class="p-0">
                                                                    <div class="collapse" id="@detailId" data-bs-parent="#@typeCollapseId">
                                                                        <div class="card rounded-0 border-top">
                                                                            <div class="card-body">
                                                                                <partial name="_ApprovalRequestDetails" model="request" />
                                                                            </div>
                                                                            <div class="card-footer bg-white">
                                                                                <button class="btn btn-outline-danger btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#reject-@request.ActionId" aria-expanded="false" aria-controls="reject-@request.ActionId">
                                                                                    <i class="fa fa-times ms-1"></i> رفض
                                                                                </button>
                                                                            </div>
                                                                            <div class="collapse border-top" id="reject-@request.ActionId" data-bs-parent="#@detailId">
                                                                                <div class="card-body">
                                                                                    <form asp-action="Reject" method="post">
                                                                                        @Html.AntiForgeryToken()
                                                                                        <input type="hidden" name="actionId" value="@request.ActionId" />
                                                                                        <div class="mb-3">
                                                                                            <label class="form-label">سبب الرفض</label>
                                                                                            <textarea name="notes" class="form-control" rows="3"></textarea>
                                                                                        </div>
                                                                                        <button type="submit" class="btn btn-danger">
                                                                                            <i class="fa fa-times ms-1"></i> تأكيد الرفض
                                                                                        </button>
                                                                                    </form>
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                </td>
                                                            </tr>
                                                        }
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                typeIndex++;
                            }
                        </div>
                    </div>
                </div>
            </div>
            userIndex++;
        }
    </div>
}
