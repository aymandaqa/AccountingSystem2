@model AccountingSystem.ViewModels.LoginViewModel
@using Microsoft.AspNetCore.Authorization
@inject IAuthorizationService AuthorizationService
@{
    ViewData["Title"] = "تسجيل الدخول";
    Layout = null;
}
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>@ViewData["Title"] - نظام المحاسبة</title>

    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.syncfusion.com/ej2/bootstrap5.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css" rel="stylesheet">

    <style>
        /* لوح الألوان */
        :root {
            --brand: #00A5A9;
            --brand-dark: #078B90;
            --brand-light: #39C6C9;
            --bg: #089BA1;
            --ink: #0f172a;
            --muted: #64748b;
        }

        /* أساسيات */
        html, body {
            height: 100%;
        }

        body {
            background: var(--bg);
            overflow: hidden;
            margin: 0;
            padding: max(12px,env(safe-area-inset-top)) max(12px,env(safe-area-inset-right)) max(12px,env(safe-area-inset-bottom)) max(12px,env(safe-area-inset-left));
        }

        /* شبكة مرنة: عمودان → عمود واحد */
        .split-wrap {
            position: relative;
            min-height: 100dvh; /* أقوى على الموبايل من 100vh */
            display: grid;
            grid-template-columns: 1fr 520px;
            align-items: center;
            gap: clamp(16px, 3vw, 36px);
        }

            /* فاصل بصري بين الجهتين */
            .split-wrap::after {
                content: "";
                position: absolute;
                inset-block: 0;
                inset-inline-end: 520px;
                width: 2px;
                background: rgba(255,255,255,.7);
                box-shadow: 0 0 0 6px rgba(255,255,255,.14);
                pointer-events: none;
            }

        /* الجزء الأيسر */
        .brand-pane {
            color: #fff;
            position: relative;
            padding: clamp(20px, 5vw, 48px);
            display: flex;
            align-items: center;
        }
            /* حلقات ديناميكية تتحجّم حسب العرض */
            .brand-pane::before,
            .brand-pane::after {
                content: "";
                position: absolute;
                border-radius: 50%;
                /* القطر يتراوح بين 360px و 900px حسب الشاشة */
                width: clamp(360px, 65vw, 900px);
                height: clamp(360px, 65vw, 900px);
                left: clamp(-140px, 6%, 10%);
                top: clamp(20px, 12%, 18%);
                border: clamp(8px, 1.2vw, 14px) solid rgba(255,255,255,.35);
                box-shadow: 0 0 0 clamp(10px, 1.6vw, 22px) rgba(255,255,255,.22), 0 0 0 clamp(18px, 2.2vw, 42px) rgba(255,255,255,.10);
                pointer-events: none;
                opacity: .85;
            }

            .brand-pane::after {
                width: clamp(300px, 52vw, 760px);
                height: clamp(300px, 52vw, 760px);
                left: clamp(-120px, 10%, 14%);
                top: clamp(40px, 16%, 22%);
                border-color: rgba(255,255,255,.28);
                box-shadow: 0 0 0 clamp(8px, 1.4vw, 18px) rgba(255,255,255,.18), 0 0 0 clamp(14px, 2vw, 36px) rgba(255,255,255,.08);
            }

        /* بطاقة زجاجية خفيفة لرفع التباين */
        .brand-card {
            max-width: 640px;
            position: relative;
            z-index: 1;
            background: rgba(255,255,255,.10);
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
            border: 1px solid rgba(255,255,255,.18);
            border-radius: 16px;
            padding: clamp(16px, 3vw, 28px);
        }

        .brand-logo {
            height: clamp(44px, 5vw, 64px);
            margin-bottom: clamp(12px, 2vw, 20px);
            filter: drop-shadow(0 6px 18px rgba(0,0,0,.25));
        }

        .brand-title {
            font-weight: 800;
            letter-spacing: .5px;
            text-shadow: 0 1px 2px rgba(0,0,0,.35);
        }

        .brand-bullets i {
            width: 24px;
            text-align: center;
            opacity: .95;
        }

        .brand-pane .lead, .brand-bullets {
            text-shadow: 0 1px 2px rgba(0,0,0,.25);
        }

        /* الجزء الأيمن */
        .login-pane {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: clamp(16px, 6vw, 64px);
        }

        .login-card {
            width: min(100%, 520px);
            background: linear-gradient(180deg,#FFFFFF 0%, #F5FFFF 100%);
            border: 1px solid rgba(0,0,0,.06);
            border-radius: 20px;
            padding: clamp(18px, 3vw, 28px);
            color: var(--ink);
            box-shadow: 0 20px 50px rgba(0,0,0,.20);
        }

            .login-card h2 {
                color: var(--ink);
                font-weight: 800;
            }

        .text-muted-acc {
            color: var(--muted);
        }

        .form-label {
            color: var(--ink);
        }

        /* حقول و أزرار مريحة للمس */
        .form-control {
            background: #F5FFFF;
            border-color: #D3EEEE;
            color: var(--ink);
            min-height: 48px;
        }

            .form-control:focus {
                border-color: var(--brand);
                box-shadow: 0 0 0 .25rem rgba(0,165,169,.18);
                background: #F5FFFF;
                color: var(--ink);
            }

        .form-check-input {
            width: 1.1em;
            height: 1.1em;
        }

        .btn-brand {
            background: linear-gradient(90deg, var(--brand) 0%, var(--brand-dark) 100%);
            border: none;
            color: #fff;
            font-weight: 700;
            min-height: 48px;
        }

            .btn-brand:hover {
                filter: brightness(1.05);
            }

        .btn .spinner-border {
            --bs-spinner-width: 1rem;
            --bs-spinner-height: 1rem;
            margin-inline-start: .5rem;
        }

        /* توست */
        #toast-container {
            position: fixed;
            inset-inline-start: 24px;
            inset-block-end: 24px;
            z-index: 1060;
        }

        .toast {
            direction: rtl;
        }

        /* نقاط توقف الاستجابة */
        @@media (max-width: 1200px) {
            .split-wrap {
                grid-template-columns: 1fr 480px;
            }

                .split-wrap::after {
                    inset-inline-end: 480px;
                }
        }

        @@media (max-width: 992px) {
            .split-wrap {
                grid-template-columns: 1fr;
                gap: 18px;
            }

                .split-wrap::after {
                    display: none;
                }
            /* إخفاء الفاصل */
            .brand-pane {
                order: 2;
                padding: 12px;
            }

            .login-pane {
                order: 1;
                padding: 12px;
            }

            .brand-card {
                background: rgba(255,255,255,.12);
            }
            /* تصغير تأثير الحلقات */
            .brand-pane::before, .brand-pane::after {
                left: -25%;
                top: 8%;
                opacity: .6;
            }
        }

        @@media (max-width: 576px) {
            .brand-bullets {
                font-size: .95rem;
            }
        }
    </style>

    <script src="https://cdn.syncfusion.com/ej2/dist/ej2.min.js"></script>
</head>
<body>

    <div class="split-wrap">
        <!-- يسار: هوية النظام -->
        <aside class="brand-pane">
            <div class="brand-card">
                <img src="https://new.roadfn.com/images/roadfn.png" alt="RoadFinity" class="brand-logo" />
                <h1 class="brand-title display-6 mb-3">نظام المحاسبة - RoadFinity</h1>
                <p class="lead text-muted-acc mb-4">
                    @*                     منصة محاسبية متكاملة لإدارة الحسابات، السندات، القيود، الأصول والتقارير بصورة ذكية وسلسة.
 *@                </p>
                <div class="brand-bullets d-grid gap-2">
                    @*        <div><i class="fa-solid fa-gauge-high me-2"></i> لوحة تحكم فورية لأداء الشركة</div>
                    <div><i class="fa-solid fa-file-invoice-dollar me-2"></i> إدارة السندات والقيود بسهولة</div>
                    <div><i class="fa-solid fa-chart-line me-2"></i> تقارير مالية تفاعلية ومتقدمة</div>
                    <div><i class="fa-solid fa-shield-halved me-2"></i> صلاحيات دقيقة وأمان عالي</div> *@
                </div>
            </div>
        </aside>

        <!-- يمين: تسجيل الدخول -->
        <main class="login-pane">
            <div class="login-card">
                <div class="mb-3 text-center">
                    <img src="https://new.roadfn.com/images/roadfn.png" alt="RoadFinity" style="height:40px; margin-bottom:6px;" />
                    <h2 class="mb-1">تسجيل الدخول</h2>
                    <p class="text-muted-acc mb-0">ادخل بيانات حسابك للوصول إلى النظام.</p>
                </div>

                <form id="loginForm" asp-action="Login" asp-route-returnUrl="@ViewData["ReturnUrl"]" method="post" novalidate>
                    @Html.AntiForgeryToken()

                    <div asp-validation-summary="All" class="text-danger small mb-2"></div>

                    <div class="mb-3">
                        <label asp-for="Email" class="form-label">البريد الإلكتروني</label>
                        <input asp-for="Email" class="form-control" placeholder="example@domain.com" autocomplete="username" />
                        <span asp-validation-for="Email" class="text-danger small"></span>
                    </div>

                    <div class="mb-3">
                        <label asp-for="Password" class="form-label">كلمة المرور</label>
                        <div class="input-group">
                            <input asp-for="Password" class="form-control" placeholder="••••••••" autocomplete="current-password" />
                            <button type="button" class="btn btn-outline-secondary toggle-password" data-target="Password" aria-label="إظهار كلمة المرور">
                                <i class="fa-regular fa-eye"></i>
                            </button>
                        </div>
                        <span asp-validation-for="Password" class="text-danger small"></span>
                    </div>

                    <input asp-for="LocationConsent" type="hidden" value="false" />
                    <input asp-for="Latitude" type="hidden" />
                    <input asp-for="Longitude" type="hidden" />
                    <input asp-for="LocationAccuracy" type="hidden" />
                    <input asp-for="LocationTimestamp" type="hidden" />
                    <input asp-for="BrowserName" type="hidden" />
                    <input asp-for="BrowserIcon" type="hidden" />

                    <button id="btnLogin" type="submit" class="btn btn-brand w-100">
                        دخول
                        <span class="spinner-border spinner-border-sm align-middle d-none" role="status" aria-hidden="true"></span>
                    </button>
                </form>

                <hr class="border-secondary-subtle my-4" />

                <div class="small text-muted-acc">
                    <i class="fa-regular fa-circle-question me-1"></i>
                    تحتاج مساعدة؟ تواصل مع مسؤول النظام لديك.
                </div>
            </div>
        </main>
    </div>

    <!-- توست الإشعارات -->
    <div id="toast-container"></div>

    <!-- سكربتات -->
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <script src="~/js/sweetalert.min.js"></script>
    <script src="~/js/site.js" asp-append-version="true"></script>

    <script>
                function showToast(message, type) {
                    const id = 't' + Date.now();
                    const bg = { success: 'bg-success', danger: 'bg-danger', warning: 'bg-warning', info: 'bg-info' }[type] || 'bg-info';
                    const html = `
        <div id="${id}" class="toast align-items-center text-white ${bg} border-0 mb-2" role="alert" aria-live="assertive" aria-atomic="true">
          <div class="d-flex">
            <div class="toast-body">${message}</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
          </div>
        </div>`;
                    $('#toast-container').append(html);
                    new bootstrap.Toast(document.getElementById(id), { autohide: false }).show();
                }

                function setButtonLoading(btn, isLoading) {
                    const $btn = $(btn), $sp = $btn.find('.spinner-border');
                    if (isLoading) {
                        $btn.attr('disabled', true);
                        $sp.removeClass('d-none');
                    } else {
                        $btn.removeAttr('disabled');
                        $sp.addClass('d-none');
                    }
                }

                const locationFields = {
                    consent: $('#LocationConsent'),
                    latitude: $('#Latitude'),
                    longitude: $('#Longitude'),
                    accuracy: $('#LocationAccuracy'),
                    timestamp: $('#LocationTimestamp')
                };

                const browserFields = {
                    name: $('#BrowserName'),
                    icon: $('#BrowserIcon')
                };

                function resolveBrowserInfo() {
                    const ua = navigator.userAgent || '';
                    let name = 'غير معروف';
                    let icon = 'fa-solid fa-globe';

                    if (/edg/i.test(ua)) {
                        name = 'Microsoft Edge';
                        icon = 'fa-brands fa-edge';
                    } else if (/opr\//i.test(ua) || /opera/i.test(ua)) {
                        name = 'Opera';
                        icon = 'fa-brands fa-opera';
                    } else if (/firefox|fxios/i.test(ua)) {
                        name = 'Mozilla Firefox';
                        icon = 'fa-brands fa-firefox-browser';
                    } else if (/chrome|crios/i.test(ua)) {
                        name = 'Google Chrome';
                        icon = 'fa-brands fa-chrome';
                    } else if (/safari/i.test(ua) && !/chrome|crios|opr\//i.test(ua)) {
                        name = 'Safari';
                        icon = 'fa-solid fa-compass';
                    } else if (/msie|trident/i.test(ua)) {
                        name = 'Internet Explorer';
                        icon = 'fa-brands fa-internet-explorer';
                    }

                    browserFields.name.val(name);
                    browserFields.icon.val(icon);
                }

                resolveBrowserInfo();

                let pendingLocationRequest = null;

                function resetLocationFields() {
                    locationFields.consent.val('false');
                    locationFields.latitude.val('');
                    locationFields.longitude.val('');
                    locationFields.accuracy.val('');
                    locationFields.timestamp.val('');
                }

                function captureLocation() {
                    if (locationFields.consent.val() === 'true' && locationFields.latitude.val() && locationFields.longitude.val()) {
                        return Promise.resolve();
                    }

                    if (!navigator.geolocation) {
                        return Promise.reject('UNSUPPORTED');
                    }

                    if (pendingLocationRequest) {
                        return pendingLocationRequest;
                    }

                    pendingLocationRequest = new Promise(function (resolve, reject) {
                        navigator.geolocation.getCurrentPosition(function (position) {
                            locationFields.consent.val('true');
                            locationFields.latitude.val(position.coords.latitude);
                            locationFields.longitude.val(position.coords.longitude);
                            locationFields.accuracy.val(position.coords.accuracy);
                            locationFields.timestamp.val(new Date(position.timestamp).toISOString());
                            resolve();
                        }, function (error) {
                            resetLocationFields();
                            reject(error);
                        }, {
                            enableHighAccuracy: true,
                            timeout: 15000,
                            maximumAge: 0
                        });
                    });

                    return pendingLocationRequest.then(function () {
                        pendingLocationRequest = null;
                    }, function (error) {
                        pendingLocationRequest = null;
                        throw error;
                    });
                }

                function submitLogin($form, $btn) {
                    $.ajax({
                        url: $form.attr('action'),
                        type: 'POST',
                        data: $form.serialize(),
                        dataType: 'json',
                        success: function (res) {
                            if (res && res.success) {
                                showToast(res.message || 'تم تسجيل الدخول بنجاح', 'success');
                                window.location.href = res.redirectUrl || '/';
                            } else {
                                showToast((res && res.message) || 'فشل تسجيل الدخول. تحقق من البيانات.', 'danger');
                                setButtonLoading($btn, false);
                            }
                        },
                        error: function (xhr) {
                            const contentType = xhr.getResponseHeader && xhr.getResponseHeader('Content-Type') || '';
                            if (contentType.includes('text/html')) {
                                document.open(); document.write(xhr.responseText); document.close();
                                return;
                            }
                            showToast('حدث خطأ غير متوقع. حاول مرة أخرى.', 'danger');
                            setButtonLoading($btn, false);
                        }
                    });
                }

                // تبديل عرض كلمة المرور
                $('.toggle-password').on('click', function () {
                    const targetId = $(this).data('target');
                    const $input = $('#' + targetId);
                    if (!$input.length) {
                        return;
                    }

                    const isPassword = $input.attr('type') === 'password';
                    $input.attr('type', isPassword ? 'text' : 'password');

                    const $icon = $(this).find('i');
                    $icon.toggleClass('fa-eye fa-eye-slash');

                    $(this).attr('aria-label', isPassword ? 'إخفاء كلمة المرور' : 'إظهار كلمة المرور');
                });

                // CSRF تلقائيًا
                $.ajaxSetup({
                    beforeSend: function (xhr, settings) {
                        if (/POST|PUT|DELETE/i.test(settings.type)) {
                            const token = $('input[name="__RequestVerificationToken"]').val();
                            if (token) {
                                xhr.setRequestHeader('RequestVerificationToken', token);
                            }
                        }
                    }
                });

                $('#loginForm').on('submit', function (e) {
                    e.preventDefault();
                    const $form = $(this);
                    const $btn = $('#btnLogin');
                    setButtonLoading($btn, true);

                    captureLocation()
                        .catch(function (error) {
                            let message = null;

                            if (error === 'UNSUPPORTED') {
                                message = 'المتصفح لا يدعم تحديد الموقع الجغرافي. سيتم المتابعة بدون مشاركة موقعك.';
                            } else if (error && (error.code === 1)) {
                                message = 'لم يتم منح صلاحية الوصول إلى الموقع. سيتم المتابعة بدون مشاركة موقعك.';
                            } else if (error && (error.code === 2)) {
                                message = 'تعذر الحصول على موقعك الحالي. سيتم المتابعة بدون مشاركة موقعك.';
                            } else if (error && (error.code === 3)) {
                                message = 'انتهت مهلة الحصول على الموقع. سيتم المتابعة بدون مشاركة موقعك.';
                            }

                            if (message) {
                                showToast(message, 'warning');
                            }
                        })
                        .then(function () {
                            submitLogin($form, $btn);
                        });
                });
    </script>

    <ejs-scripts></ejs-scripts>
</body>
</html>
