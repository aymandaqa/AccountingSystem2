@using System
@model IEnumerable<AccountingSystem.ViewModels.AccountTreeNodeViewModel>
@{
    var baseCurrencyCode = ViewData["DashboardBaseCurrencyCode"] as string ?? string.Empty;
}

@foreach (var node in Model)
{
    var hasChildren = node.Children.Any();
    var collapseId = $"dashboard-account-{node.Id}-{Guid.NewGuid():N}";
    <li class="dashboard-account-node">
        <div class="d-flex align-items-start gap-3 flex-wrap flex-md-nowrap">
            <div class="d-flex align-items-start gap-2 flex-grow-1">
                @if (hasChildren)
                {
                    <button type="button"
                            class="btn btn-sm btn-outline-secondary d-inline-flex align-items-center justify-content-center dashboard-toggle collapsed"
                            data-bs-toggle="collapse"
                            data-bs-target="#@collapseId"
                            aria-expanded="false"
                            aria-controls="@collapseId">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                }
                else
                {
                    <span class="dashboard-toggle-placeholder">
                        <i class="fas fa-circle"></i>
                    </span>
                }
                <div>
                    <div class="fw-semibold text-nowrap">@(!string.IsNullOrWhiteSpace(node.Code) ? $"{node.Code} - " : string.Empty)@node.NameAr</div>
                    <div class="text-muted small">@node.CurrencyCode</div>
                </div>
            </div>
            <div class="text-end" style="width: 180px;">
                <div class="fw-semibold">@node.BalanceBase.ToString("N2")</div>
                @if (!string.IsNullOrWhiteSpace(baseCurrencyCode))
                {
                    <div class="text-muted small">@baseCurrencyCode</div>
                }
            </div>
            <div class="text-center" style="width: 150px;">
                @if (node.Id > 0)
                {
                    <a class="btn btn-outline-primary btn-sm"
                       asp-controller="Reports"
                       asp-action="AccountStatement"
                       asp-route-accountId="@node.Id"
                       target="_blank"
                       asp-require-permission="reports.accountstatement">
                        <i class="fas fa-file-alt ms-1"></i> كشف حساب
                    </a>
                }
                else
                {
                    <span class="text-muted">-</span>
                }
            </div>
        </div>

        @if (hasChildren)
        {
            <div class="collapse dashboard-account-children" id="@collapseId">
                <ul class="list-unstyled ms-4 ps-3 border-start">
                    @await Html.PartialAsync("_DashboardAccountSubTable", node.Children, new ViewDataDictionary(ViewData)
                    {
                        ["DashboardBaseCurrencyCode"] = baseCurrencyCode
                    })
                </ul>
            </div>
        }
    </li>
}
