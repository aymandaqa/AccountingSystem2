@using AccountingSystem.ViewModels
@using Microsoft.AspNetCore.Authorization
@model DashboardViewModel
@inject IAuthorizationService AuthorizationService

@{
    ViewData["Title"] = "لوحة التحكم";
    Layout = "_AccountingLayout";
    var canViewStats = (await AuthorizationService.AuthorizeAsync(User, "dashboard.widget.stats")).Succeeded;
    var canViewAccounts = (await AuthorizationService.AuthorizeAsync(User, "dashboard.widget.accounts")).Succeeded;
    var canViewLinks = (await AuthorizationService.AuthorizeAsync(User, "dashboard.widget.links")).Succeeded;
    var canViewCashBoxes = (await AuthorizationService.AuthorizeAsync(User, "dashboard.widget.cashboxes")).Succeeded;
}

<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-tachometer-alt me-2"></i>
                        لوحة التحكم الرئيسية
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <label for="branchFilter" class="form-label">فلتر حسب الفرع:</label>
                            <select id="branchFilter" class="form-select" onchange="applyFilters()">
                                <option value="">جميع الفروع</option>
                                @if (ViewBag.Branches != null)
                                {
                                    @foreach (var branch in ViewBag.Branches)
                                    {
                                        <option value="@branch.Id" selected="@(Model.SelectedBranchId == branch.Id ? "selected" : null)">
                                            @branch.NameAr
                                        </option>
                                    }
                                }
                            </select>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="fromDateFilter" class="form-label">من تاريخ:</label>
                            <input type="date" id="fromDateFilter" class="form-control" value="@Model.FromDate.ToString("yyyy-MM-dd")" onchange="applyFilters()" />
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="toDateFilter" class="form-label">إلى تاريخ:</label>
                            <input type="date" id="toDateFilter" class="form-control" value="@Model.ToDate.ToString("yyyy-MM-dd")" onchange="applyFilters()" />
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- إحصائيات سريعة -->
    @if (canViewStats)
    {
    <div class="row mb-4">
        <div class="col-lg-2 col-md-4 mb-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">إجمالي الأصول</h6>
                            <h4 class="mb-0">@Model.TotalAssets.ToString("N0")</h4>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-chart-line fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-2 col-md-4 mb-3">
            <div class="card bg-danger text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">إجمالي الخصوم</h6>
                            <h4 class="mb-0">@Model.TotalLiabilities.ToString("N0")</h4>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-balance-scale fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-2 col-md-4 mb-3">
            <div class="card bg-secondary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">إجمالي حقوق الملكية</h6>
                            <h4 class="mb-0">@Model.TotalEquity.ToString("N0")</h4>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-university fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-2 col-md-4 mb-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">إجمالي الإيرادات</h6>
                            <h4 class="mb-0">@Model.TotalRevenues.ToString("N0")</h4>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-dollar-sign fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-2 col-md-4 mb-3">
            <div class="card bg-warning text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">إجمالي المصروفات</h6>
                            <h4 class="mb-0">@Model.TotalExpenses.ToString("N0")</h4>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-shopping-cart fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-2 col-md-4 mb-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title">صافي الربح</h6>
                            <h4 class="mb-0">@Model.NetIncome.ToString("N0")</h4>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-chart-pie fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    }

    <!-- أرصدة الصناديق -->
    @if (canViewCashBoxes)
    {
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-cash-register me-2"></i>
                        أرصدة الصناديق
                    </h5>
                </div>
                <div class="card-body">
                    @if (Model.CashBoxes.Any())
                    {
                        <table class="table table-bordered">
                            <thead>
                                <tr>
                                    <th>الفرع</th>
                                    <th>الحساب</th>
                                    <th>الرصيد</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var cb in Model.CashBoxes)
                                {
                                    <tr>
                                        <td>@cb.BranchName</td>
                                        <td>@cb.AccountName</td>
                                        <td>@cb.Balance.ToString("N2")</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    }
                    else
                    {
                        <div class="alert alert-info text-center">
                            لا توجد بيانات لعرضها
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
    }

    <!-- أرصدة الحسابات -->
    @if (canViewAccounts)
    {
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-sitemap me-2"></i>
                        أرصدة الحسابات حسب النوع
                    </h5>
                </div>
                <div class="card-body">
                    @if (Model.AccountTypeTrees.Any())
                    {
                        <div class="tree-container">
                            @await Html.PartialAsync("_AccountBalanceTreeNode", Model.AccountTypeTrees)
                        </div>
                    }
                    else
                    {
                        <div class="alert alert-info text-center">
                            لا توجد بيانات لعرضها
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
    }

    <!-- الروابط السريعة -->
    @if (canViewLinks)
    {
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-link me-2"></i>
                        الروابط السريعة
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
                            <a href="@Url.Action("Index", "Accounts")" class="btn btn-outline-primary w-100">
                                <i class="fas fa-list-alt d-block mb-2"></i>
                                إدارة الحسابات
                            </a>
                        </div>
                        <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
                            <a href="@Url.Action("Tree", "Accounts")" class="btn btn-outline-success w-100">
                                <i class="fas fa-sitemap d-block mb-2"></i>
                                شجرة الحسابات
                            </a>
                        </div>
                        <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
                            <a href="@Url.Action("Index", "JournalEntries")" class="btn btn-outline-info w-100">
                                <i class="fas fa-book d-block mb-2"></i>
                                القيود المالية
                            </a>
                        </div>
                        <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
                            <a href="@Url.Action("Index", "Reports")" class="btn btn-outline-warning w-100">
                                <i class="fas fa-chart-bar d-block mb-2"></i>
                                التقارير المالية
                            </a>
                        </div>
                        <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
                            <a href="@Url.Action("Index", "Branches")" class="btn btn-outline-secondary w-100">
                                <i class="fas fa-building d-block mb-2"></i>
                                إدارة الفروع
                            </a>
                        </div>
                        <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
                            <a href="@Url.Action("Index", "CostCenters")" class="btn btn-outline-dark w-100">
                                <i class="fas fa-bullseye d-block mb-2"></i>
                                مراكز التكلفة
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    }
</div>

@section Styles {
    <style>
        .tree-container {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .tree-node {
            margin: 5px 0;
            padding: 8px;
            border-radius: 5px;
        }

        .tree-node-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .tree-node-info {
            display: flex;
            align-items: center;
            flex-grow: 1;
        }

        .tree-children {
            margin-right: 25px;
            border-right: 2px solid #e9ecef;
            padding-right: 15px;
        }

        .account-code {
            font-weight: bold;
            color: #495057;
            margin-left: 10px;
        }

        .account-name {
            color: #212529;
            margin-left: 10px;
        }

        .toggle-btn {
            background: none;
            border: none;
            color: #6c757d;
            cursor: pointer;
            padding: 0;
            margin-left: 5px;
            width: 20px;
            text-align: center;
        }

            .toggle-btn:hover {
                color: #495057;
            }
    </style>
}

@section Scripts {
    <script>
        function applyFilters() {
            const branchId = document.getElementById('branchFilter').value;
            const fromDate = document.getElementById('fromDateFilter').value;
            const toDate = document.getElementById('toDateFilter').value;
            const url = new URL(window.location);
            if (branchId) {
                url.searchParams.set('branchId', branchId);
            } else {
                url.searchParams.delete('branchId');
            }
            if (fromDate) {
                url.searchParams.set('fromDate', fromDate);
            } else {
                url.searchParams.delete('fromDate');
            }
            if (toDate) {
                url.searchParams.set('toDate', toDate);
            } else {
                url.searchParams.delete('toDate');
            }
            window.location.href = url.toString();
        }

        $(function () {
            $('.toggle-btn').on('click', function () {
                var $this = $(this);
                var $children = $this.closest('.tree-node').find('> .tree-children');
                if ($children.is(':visible')) {
                    $children.hide();
                    $this.html('<i class="fas fa-plus"></i>');
                } else {
                    $children.show();
                    $this.html('<i class="fas fa-minus"></i>');
                }
            });
        });
        $(document).ready(function () {
                    $('.tree-node[data-level="0"] .toggle-btn').click();
                      });
    </script>
}

