@using System.Collections.Generic
@model AccountingSystem.ViewModels.JournalEntriesIndexViewModel

@{
    ViewData["Title"] = "القيود المالية";
    var toolbarItems = new List<string> { "Search", "ExcelExport", "Print" };
}

@section Styles {
    <style>
        .table-actions .btn {
            min-width: 2.25rem;
        }

            .table-actions .btn i {
                pointer-events: none;
            }

        .filters-card .form-label {
            font-weight: 600;
        }
    </style>
}

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header d-flex flex-column flex-lg-row align-items-lg-center justify-content-between gap-2">
                    <h3 class="card-title mb-0">
                        <i class="fas fa-file-invoice me-2"></i>
                        القيود المالية
                    </h3>
                    <div class="d-flex flex-column flex-md-row align-items-md-center gap-2">
                        <a asp-action="Create" class="btn btn-primary" asp-require-permission="journal.create">
                            <i class="fas fa-plus me-1"></i>
                            إضافة قيد جديد
                        </a>
                    </div>
                </div>
                <div class="card-body filters-card">
                    <form id="filtersForm" class="row g-3 align-items-end mb-3">
                        <div class="col-sm-6 col-lg-3">
                            <label for="fromDate" class="form-label">من تاريخ</label>
                            <input type="date" id="fromDate" class="form-control" />
                        </div>
                        <div class="col-sm-6 col-lg-3">
                            <label for="toDate" class="form-label">إلى تاريخ</label>
                            <input type="date" id="toDate" class="form-control" />
                        </div>
                        <div class="col-sm-6 col-lg-3">
                            <label for="branchFilter" class="form-label">الفرع</label>
                            <select id="branchFilter" class="form-select">
                                @foreach (var branch in Model.Branches)
                                {
                                    <option value="@branch.Value">@branch.Text</option>
                                }
                            </select>
                        </div>
                        <div class="col-sm-6 col-lg-3">
                            <label for="statusFilter" class="form-label">الحالة</label>
                            <select id="statusFilter" class="form-select">
                                @foreach (var status in Model.Statuses)
                                {
                                    <option value="@status.Value">@status.Text</option>
                                }
                            </select>
                        </div>
                        <div class="col-sm-6 col-lg-3">
                            <label for="groupBy" class="form-label">تجميع النتائج</label>
                            <select id="groupBy" class="form-select">
                                <option value="" selected>بدون تجميع</option>
                                <option value="BranchName">حسب الفرع</option>
                                <option value="StatusDisplay">حسب الحالة</option>
                                <option value="DateGroup">حسب الشهر</option>
                                <option value="Reference">حسب المرجع</option>
                            </select>
                        </div>
                        <div class="col-sm-6 col-lg-3 d-flex">
                            <button type="button" id="resetFilters" class="btn btn-outline-secondary w-100 mt-auto">
                                <i class="fas fa-undo"></i> إعادة تعيين
                            </button>
                        </div>
                    </form>

                    <ejs-grid id="journalEntriesGrid"
                              allowPaging="true"
                              allowSorting="true"
                              allowFiltering="true"
                              allowGrouping="true"
                              allowExcelExport="true"
                              enableStickyHeader="true"
                              enableRtl="true"
                              allowSelection="false"
                              height="500"
                              gridLines="Both"
                              toolbar="@toolbarItems">
                        <e-data-manager url="@Url.Action("UrlDatasourceJournalEntries", "JournalEntries")" adaptor="UrlAdaptor"></e-data-manager>
                        <e-grid-filterSettings type="Excel"></e-grid-filterSettings>
                        <e-grid-columns>
                            <e-grid-column field="Number" headerText="رقم القيد" width="140"></e-grid-column>
                            <e-grid-column field="Date" headerText="التاريخ" format="yyyy-MM-dd HH:mm" type="date" textAlign="Center" width="140"></e-grid-column>
                            <e-grid-column field="Description" headerText="الوصف" width="220"></e-grid-column>
                            <e-grid-column field="Reference" headerText="المرجع" width="180"></e-grid-column>
                            <e-grid-column field="BranchName" headerText="الفرع" width="180"></e-grid-column>
                            <e-grid-column field="TotalAmount" headerText="المبلغ الإجمالي" format="N2" type="number" textAlign="Right" width="170"></e-grid-column>
                            <e-grid-column field="LinesCount" headerText="عدد البنود" textAlign="Center" width="130"></e-grid-column>
                            <e-grid-column field="StatusDisplay" headerText="الحالة" template="#statusTemplate" textAlign="Center" width="140"></e-grid-column>
                            <e-grid-column field="DateGroup" headerText="الشهر" visible="false"></e-grid-column>
                            <e-grid-column field="Id" headerText="الإجراءات" template="#actionsTemplate" textAlign="Center" width="210" allowSorting="false" allowFiltering="false"></e-grid-column>
                        </e-grid-columns>
                    </ejs-grid>

                    <form id="antiForgeryForm" asp-action="Post" method="post" class="d-none">
                        @Html.AntiForgeryToken()
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script id="statusTemplate" type="text/x-template">
        <span class="badge ${StatusClass}">${StatusDisplay}</span>
    </script>

    <script id="actionsTemplate" type="text/x-template">
        <div class="d-flex justify-content-center flex-wrap gap-2 table-actions" role="group">
            <a href="@Url.Action("Details", "JournalEntries")/${Id}" class="btn btn-sm btn-outline-info" title="عرض" asp-require-permission="journal.view">
                <i class="fas fa-eye"></i>
            </a>
            ${if(IsDraft)}
            <a href="@Url.Action("Edit", "JournalEntries")/${Id}" class="btn btn-sm btn-outline-warning" title="تعديل" asp-require-permission="journal.edit">
                <i class="fas fa-edit"></i>
            </a>
            <button type="button" class="btn btn-sm btn-outline-success btn-post-entry" data-id="${Id}" data-number="${Number}" title="ترحيل" asp-require-permission="journal.approve">
                <i class="fas fa-share"></i>
            </button>
            ${/if}
            <a href="@Url.Action("Print", "JournalEntries")/${Id}" target="_blank" class="btn btn-sm btn-outline-secondary" title="طباعة">
                <i class="fas fa-print"></i>
            </a>
        </div>
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            var dataUrl = '@Url.Action("UrlDatasourceJournalEntries", "JournalEntries")';
            var postUrlBase = '@Url.Action("Post", "JournalEntries")';
            var gridElement = document.getElementById('journalEntriesGrid');
            if (!gridElement || !gridElement.ej2_instances || !gridElement.ej2_instances.length) {
                return;
            }

            var grid = gridElement.ej2_instances[0];
            var trackedRequestTypes = ['paging', 'sorting', 'filtering', 'searching', 'grouping', 'ungrouping', 'refresh'];

            grid.pageSettings = { pageSize: 10, pageSizes: [10, 25, 50, 100, 'All'] };
            grid.groupSettings = { showDropArea: false, columns: ['Reference'] };

            grid.actionBegin = function (args) {
                if (trackedRequestTypes.indexOf(args.requestType) > -1) {
                    showLoading();
                }
            };

            grid.actionComplete = function (args) {
                if (trackedRequestTypes.indexOf(args.requestType) > -1) {
                    hideLoading();
                }
            };

            grid.dataBound = function () {
                hideLoading();
            };

            grid.actionFailure = function () {
                hideLoading();
            };

            function buildDataUrl() {
                var params = new URLSearchParams();
                var fromDate = document.getElementById('fromDate').value;
                var toDate = document.getElementById('toDate').value;
                var branchId = document.getElementById('branchFilter').value;
                var status = document.getElementById('statusFilter').value;

                if (fromDate) params.append('fromDate', fromDate);
                if (toDate) params.append('toDate', toDate);
                if (branchId) params.append('branchId', branchId);
                if (status) params.append('status', status);

                var query = params.toString();
                return query ? dataUrl + '?' + query : dataUrl;
            }

            function reloadGrid() {
                showLoading();
                grid.dataSource = new ej.data.DataManager({
                    url: buildDataUrl(),
                    adaptor: new ej.data.UrlAdaptor()
                });
                grid.refresh();
            }

            grid.dataSource = new ej.data.DataManager({
                url: buildDataUrl(),
                adaptor: new ej.data.UrlAdaptor()
            });

            ['fromDate', 'toDate', 'branchFilter', 'statusFilter'].forEach(function (id) {
                var element = document.getElementById(id);
                if (!element) return;
                element.addEventListener('change', function () {
                    grid.pageSettings.currentPage = 1;
                    reloadGrid();
                });
            });

            var resetButton = document.getElementById('resetFilters');
            if (resetButton) {
                resetButton.addEventListener('click', function () {
                    document.getElementById('fromDate').value = '';
                    document.getElementById('toDate').value = '';
                    document.getElementById('branchFilter').selectedIndex = 0;
                    document.getElementById('statusFilter').selectedIndex = 0;
                    document.getElementById('groupBy').value = 'Reference';

                    grid.clearFiltering();
                    grid.clearSorting();
                    grid.searchSettings.key = '';
                    grid.clearGrouping();
                    grid.groupColumn('Reference');
                    grid.pageSettings.currentPage = 1;
                    reloadGrid();
                });
            }

            var groupSelect = document.getElementById('groupBy');
            if (groupSelect) {
                if (groupSelect.value) {
                    grid.clearGrouping();
                    grid.groupColumn(groupSelect.value);
                }
                groupSelect.addEventListener('change', function (event) {
                    grid.clearGrouping();
                    var value = event.target.value;
                    if (value) {
                        grid.groupColumn(value);
                    }
                });
            }

            document.getElementById('journalEntriesGrid').addEventListener('click', function (event) {
                var button = event.target.closest('.btn-post-entry');
                if (!button) {
                    return;
                }

                var id = button.getAttribute('data-id');
                var number = button.getAttribute('data-number');
                if (!id) {
                    return;
                }

                if (!confirm('هل تريد ترحيل القيد رقم ' + number + '?')) {
                    return;
                }

                showLoading();
                $.ajax({
                    url: postUrlBase + '/' + id,
                    type: 'POST',
                    success: function () {
                        hideLoading();
                        grid.refresh();
                        if (window.swal) {
                            swal({ title: 'تم الترحيل بنجاح', icon: 'success', button: 'حسناً' });
                        } else {
                            alert('تم ترحيل القيد بنجاح');
                        }
                    },
                    error: function (xhr) {
                        hideLoading();
                        var message = xhr.responseText || 'تعذر ترحيل القيد.';
                        if (window.swal) {
                            swal({ title: 'خطأ', text: message, icon: 'error', button: 'إغلاق' });
                        } else {
                            alert(message);
                        }
                    }
                });
            });
        });
    </script>
}
