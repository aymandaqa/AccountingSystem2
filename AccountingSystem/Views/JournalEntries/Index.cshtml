@using System.Collections.Generic
@model AccountingSystem.ViewModels.JournalEntriesIndexViewModel

@{
    ViewData["Title"] = "القيود المالية";
    var toolbarItems = new List<string> { "ColumnChooser", "ExcelExport", "Print" };
}

@section Styles {
    <style>
        :root {
            color-scheme: light;
        }

        .journal-index {
            padding-inline: clamp(0.75rem, 1vw, 2rem);
            padding-block: 1.25rem 2rem;
            min-height: 100vh;
        }

        @supports (height: 100dvh) {
            .journal-index {
                min-height: 100dvh;
            }
        }

        .journal-shell {
            border: none;
            border-radius: 1rem;
            overflow: hidden;
        }

        .journal-shell .card-header {
            background: linear-gradient(135deg, rgba(13, 110, 253, 0.12), rgba(13, 110, 253, 0.03));
            border-bottom: none;
            padding: clamp(1.25rem, 2vw, 1.75rem);
        }

        .journal-shell .headline {
            display: grid;
            gap: 1.5rem;
        }

        @media (min-width: 992px) {
            .journal-shell .headline {
                grid-template-columns: minmax(0, 1fr) auto;
                align-items: center;
            }
        }

        .headline__title {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .headline__title h3 {
            display: flex;
            align-items: center;
            gap: 0.6rem;
            font-size: clamp(1.35rem, 2vw, 1.7rem);
            color: #0b4d94;
            margin: 0;
        }

        .headline__title p {
            margin: 0;
            color: #4f5d75;
            max-width: 48ch;
        }

        .headline__actions {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            align-items: center;
            justify-content: flex-start;
        }

        .search-shell {
            flex: 1 1 clamp(16rem, 28vw, 24rem);
            min-width: 14rem;
            position: relative;
        }

        .search-shell .input-group-text {
            background-color: #f1f3f5;
            border-inline-end: none;
        }

        .search-shell .form-control {
            border-inline-start: none;
            box-shadow: none;
        }

        .search-shell .btn-clear-search {
            border-radius: 0 var(--bs-border-radius) var(--bs-border-radius) 0;
        }

        .headline__actions .btn-refresh {
            position: relative;
        }

        .summary-section {
            margin-top: 1.75rem;
            display: grid;
            gap: 0.85rem;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(14.5rem, 1fr));
            gap: 0.85rem;
        }

        .summary-card {
            border-radius: 0.9rem;
            border: 1px solid rgba(13, 110, 253, 0.18);
            background: linear-gradient(135deg, rgba(13, 110, 253, 0.1), rgba(13, 110, 253, 0.02));
            padding: 1rem 1.25rem;
            display: flex;
            flex-direction: column;
            gap: 0.35rem;
            min-height: 6.5rem;
        }

        .summary-card__label {
            font-size: 0.85rem;
            color: #1f3b5b;
            font-weight: 600;
        }

        .summary-card__value {
            font-size: clamp(1.35rem, 2.2vw, 1.9rem);
            font-weight: 700;
            color: #0b4d94;
        }

        .summary-card__hint {
            font-size: 0.8rem;
            color: #4f5d75;
        }

        .summary-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            align-items: center;
            color: #6c757d;
            font-size: 0.85rem;
        }

        .insights-panel {
            border-radius: 0.75rem;
            border: 1px dashed rgba(13, 110, 253, 0.35);
            background-color: #f8f9ff;
            padding: 1rem 1.25rem;
        }

        .insights-panel strong {
            color: #0b4d94;
        }

        .filters-card {
            background-color: #fff;
            border: 1px solid rgba(15, 67, 130, 0.08);
            border-radius: 0.85rem;
            padding: 1.1rem 1.25rem;
        }

        .filters-toolbar {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            align-items: center;
        }

        .filters-toolbar .btn-toggle {
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            font-weight: 600;
        }

        .filters-toolbar .active-filters-count {
            background-color: #0b4d94;
            color: #fff;
            border-radius: 999px;
            padding: 0.15rem 0.6rem;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .filters-toolbar .btn-reset {
            color: #b02a37;
            font-weight: 600;
        }

        .active-filters {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.85rem;
        }

        .filter-chip {
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            padding: 0.35rem 0.75rem;
            background-color: #e7f1ff;
            border-radius: 999px;
            border: 1px solid rgba(15, 67, 130, 0.15);
            font-size: 0.8rem;
            font-weight: 600;
            color: #0b4d94;
        }

        .filter-chip button {
            border: none;
            background: transparent;
            color: inherit;
            display: inline-flex;
            align-items: center;
            padding: 0;
            font-size: 0.85rem;
        }

        .filters-card .form-label {
            font-weight: 600;
            color: #1f3b5b;
        }

        .filters-card .form-select,
        .filters-card .form-control {
            box-shadow: none;
        }

        .filters-card .form-switch .form-check-input {
            width: 2.5rem;
            height: 1.25rem;
        }

        .filters-card .form-switch .form-check-label {
            font-weight: 600;
            color: #1f3b5b;
        }

        .grid-wrapper {
            background-color: #fff;
            border: 1px solid rgba(15, 67, 130, 0.08);
            border-radius: 0.85rem;
            padding: 0.5rem;
            min-height: 24rem;
            position: relative;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .grid-caption {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.35rem 0.75rem 0;
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        .grid-caption .result-info {
            font-size: 0.85rem;
            color: #4f5d75;
        }

        .grid-caption .badge {
            font-size: 0.75rem;
        }

        .grid-wrapper .e-grid {
            height: calc(100% - 2.25rem);
        }

        .table-actions .btn {
            min-width: 2.25rem;
            font-size: 0.85rem;
        }

        .table-actions .btn i {
            pointer-events: none;
        }

        .unbalanced-entry {
            background-color: #fdeaea;
        }

        .unbalanced-entry .e-rowcell {
            color: #b71c1c;
        }

        @media (max-width: 767.98px) {
            .journal-index {
                padding-inline: 0.5rem;
                padding-block: 1rem 1.5rem;
            }

            .summary-grid {
                grid-template-columns: repeat(auto-fill, minmax(12rem, 1fr));
            }

            .filters-card {
                padding: 0.85rem;
            }

            .grid-wrapper {
                padding: 0.35rem;
            }
        }
    </style>
}

<div class="journal-index container-fluid">
    <div class="card journal-shell shadow-sm">
        <div class="card-header">
            <div class="headline">
                <div class="headline__title">
                    <h3>
                        <i class="fas fa-file-invoice"></i>
                        <span>القيود المالية</span>
                    </h3>
                    <p>
                        إدارة القيود بسهولة، مع نظرة فورية على التوازن والفلترة الذكية عبر جميع الحقول.
                    </p>
                </div>
                <div class="headline__actions">
                    <div class="search-shell">
                        <label class="visually-hidden" for="quickSearch">بحث سريع</label>
                        <div class="input-group" role="search">
                            <span class="input-group-text"><i class="fas fa-search"></i></span>
                            <input type="search" id="quickSearch" class="form-control" placeholder="بحث سريع في جميع الأعمدة" aria-label="بحث سريع" />
                            <button type="button" id="clearQuickSearch" class="btn btn-outline-secondary btn-clear-search" title="مسح البحث">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    <button type="button" class="btn btn-outline-primary btn-refresh" id="refreshGrid" title="تحديث القائمة">
                        <i class="fas fa-sync-alt"></i>
                        <span class="d-none d-lg-inline">تحديث</span>
                    </button>
                    <a asp-action="Create" class="btn btn-primary" asp-require-permission="journal.create">
                        <i class="fas fa-plus me-1"></i>
                        إضافة قيد جديد
                    </a>
                </div>
            </div>
            <div class="summary-section" aria-live="polite">
                <div class="summary-grid">
                    <div class="summary-card">
                        <span class="summary-card__label">إجمالي القيود</span>
                        <span class="summary-card__value" id="summaryTotal">0</span>
                        <span class="summary-card__hint" id="summaryTotalStatus">—</span>
                    </div>
                    <div class="summary-card">
                        <span class="summary-card__label">القيود غير المتوازنة</span>
                        <span class="summary-card__value text-danger" id="summaryUnbalanced">0</span>
                        <span class="summary-card__hint">تنبيه لأي فروقات بين المدين والدائن</span>
                    </div>
                    <div class="summary-card">
                        <span class="summary-card__label">إجمالي المدين</span>
                        <span class="summary-card__value" id="summaryDebit">0</span>
                        <span class="summary-card__hint">المبالغ الإجمالية (مدين)</span>
                    </div>
                    <div class="summary-card">
                        <span class="summary-card__label">إجمالي الدائن</span>
                        <span class="summary-card__value" id="summaryCredit">0</span>
                        <span class="summary-card__hint">المبالغ الإجمالية (دائن)</span>
                    </div>
                    <div class="summary-card">
                        <span class="summary-card__label">نسبة التوازن</span>
                        <span class="summary-card__value" id="summaryBalanceRatio">0%</span>
                        <span class="summary-card__hint">قيود متوازنة من إجمالي القيود</span>
                    </div>
                </div>
                <div class="summary-meta">
                    <span><i class="fas fa-info-circle"></i> <span id="summaryInsight">لا توجد بيانات حتى الآن.</span></span>
                    <span><i class="fas fa-clock"></i> آخر تحديث: <span id="lastRefreshAt">—</span></span>
                </div>
                <div class="insights-panel" id="insightsPanel" hidden>
                    <strong>اقتراحات محسّنة:</strong>
                    <ul class="mb-0" id="smartSuggestions"></ul>
                </div>
            </div>
        </div>
        <div class="card-body d-flex flex-column gap-3">
            <div class="filters-card">
                <div class="filters-toolbar">
                    <button class="btn btn-outline-secondary btn-toggle" type="button" data-bs-toggle="collapse" data-bs-target="#filtersCollapse" aria-expanded="true" aria-controls="filtersCollapse">
                        <i class="fas fa-sliders-h"></i>
                        خيارات متقدمة
                    </button>
                    <div class="form-check form-switch ms-auto">
                        <input class="form-check-input" type="checkbox" role="switch" id="showUnbalancedOnly">
                        <label class="form-check-label" for="showUnbalancedOnly">عرض القيود غير المتوازنة فقط</label>
                    </div>
                    <span class="active-filters-count d-none" id="activeFiltersCount">0</span>
                    <button type="button" id="resetFilters" class="btn btn-link btn-reset text-decoration-none">
                        <i class="fas fa-undo"></i>
                        إعادة تعيين
                    </button>
                </div>
                <div class="active-filters" id="activeFilters" aria-live="polite"></div>
                <div class="collapse show" id="filtersCollapse">
                    <form id="filtersForm" class="row g-3 pt-3" autocomplete="off">
                        <div class="col-sm-6 col-lg-3">
                            <label for="fromDate" class="form-label">من تاريخ</label>
                            <input type="date" id="fromDate" class="form-control" />
                        </div>
                        <div class="col-sm-6 col-lg-3">
                            <label for="toDate" class="form-label">إلى تاريخ</label>
                            <input type="date" id="toDate" class="form-control" />
                        </div>
                        <div class="col-sm-6 col-lg-3">
                            <label for="branchFilter" class="form-label">الفرع</label>
                            <select id="branchFilter" class="form-select">
                                <option value="">كل الفروع</option>
                                @foreach (var branch in Model.Branches)
                                {
                                    <option value="@branch.Value">@branch.Text</option>
                                }
                            </select>
                        </div>
                        <div class="col-sm-6 col-lg-3">
                            <label for="statusFilter" class="form-label">الحالة</label>
                            <select id="statusFilter" class="form-select">
                                <option value="">جميع الحالات</option>
                                @foreach (var status in Model.Statuses)
                                {
                                    <option value="@status.Value">@status.Text</option>
                                }
                            </select>
                        </div>
                        <div class="col-sm-6 col-lg-3">
                            <label for="groupBy" class="form-label">تجميع النتائج</label>
                            <select id="groupBy" class="form-select">
                                <option value="" selected>بدون تجميع</option>
                                <option value="BranchName">حسب الفرع</option>
                                <option value="StatusDisplay">حسب الحالة</option>
                                <option value="DateGroup">حسب الشهر</option>
                                <option value="Reference">حسب المرجع</option>
                            </select>
                        </div>
                    </form>
                </div>
            </div>

            <div class="grid-wrapper">
                <div class="grid-caption">
                    <div class="d-flex align-items-center gap-2">
                        <i class="fas fa-database text-primary"></i>
                        <span class="result-info" id="gridResultInfo">لا توجد بيانات بعد</span>
                    </div>
                    <div class="d-flex align-items-center gap-2">
                        <span class="badge bg-light text-dark" id="groupingInfo" hidden>العرض مجمع</span>
                    </div>
                </div>
                <ejs-grid id="journalEntriesGrid"
                          allowPaging="true"
                          allowSorting="true"
                          allowFiltering="true"
                          allowGrouping="true"
                          allowExcelExport="true"
                          allowTextWrap="true"
                          allowResizing="true"
                          allowReordering="true"
                          allowSelection="false"
                          showColumnChooser="true"
                          enableStickyHeader="true"
                          enableRtl="true"
                          width="100%"
                          height="100%"
                          gridLines="Both"
                          toolbar="@toolbarItems">
                    <e-data-manager url="@Url.Action("UrlDatasourceJournalEntries", "JournalEntries")" adaptor="UrlAdaptor"></e-data-manager>
                    <e-grid-filterSettings type="Excel"></e-grid-filterSettings>
                    <e-grid-pageSettings pageSize="25" pageSizes="@(new object[] { 10, 25, 50, 100, "All" })"></e-grid-pageSettings>
                    <e-grid-aggregates>
                        <e-grid-aggregate>
                            <e-aggregate-columns>
                                <e-aggregate-column field="TotalDebit" type="Sum" format="N2" footerTemplate="<div class='text-end fw-semibold'>إجمالي المدين: ${Sum}</div>" groupCaptionTemplate="<span class='fw-semibold text-primary'>إجمالي المدين: ${Sum}</span>"></e-aggregate-column>
                                <e-aggregate-column field="TotalCredit" type="Sum" format="N2" footerTemplate="<div class='text-end fw-semibold'>إجمالي الدائن: ${Sum}</div>" groupCaptionTemplate="<span class='fw-semibold text-primary'>إجمالي الدائن: ${Sum}</span>"></e-aggregate-column>
                            </e-aggregate-columns>
                        </e-grid-aggregate>
                    </e-grid-aggregates>
                    <e-grid-columns>
                        <e-grid-column field="Number" headerText="رقم القيد" width="140"></e-grid-column>
                        <e-grid-column field="Date" headerText="التاريخ" format="dd/MM/yyyy HH:mm" type="date" textAlign="Center" width="160"></e-grid-column>
                        <e-grid-column field="Description" headerText="الوصف" width="260"></e-grid-column>
                        <e-grid-column field="Reference" headerText="المرجع" width="200"></e-grid-column>
                        <e-grid-column field="BranchName" headerText="الفرع" width="200"></e-grid-column>
                        <e-grid-column field="CreatedByName" headerText="مدخل القيد" width="200"></e-grid-column>
                        <e-grid-column field="TotalDebit" headerText="إجمالي المدين" format="N2" type="number" textAlign="Right" width="180"></e-grid-column>
                        <e-grid-column field="TotalCredit" headerText="إجمالي الدائن" format="N2" type="number" textAlign="Right" width="180"></e-grid-column>
                        <e-grid-column field="LinesCount" headerText="عدد البنود" textAlign="Center" width="140"></e-grid-column>
                        <e-grid-column field="StatusDisplay" headerText="الحالة" template="#statusTemplate" textAlign="Center" width="150"></e-grid-column>
                        <e-grid-column field="DateGroup" headerText="الشهر" visible="false"></e-grid-column>
                        <e-grid-column field="IsBalanced" visible="false"></e-grid-column>
                        <e-grid-column field="Id" headerText="الإجراءات" template="#actionsTemplate" textAlign="Center" width="230" allowSorting="false" allowFiltering="false"></e-grid-column>
                    </e-grid-columns>
                </ejs-grid>
            </div>

            <form id="antiForgeryForm" asp-action="Post" method="post" class="d-none">
                @Html.AntiForgeryToken()
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script id="statusTemplate" type="text/x-template">
        <span class="badge ${StatusClass}">${StatusDisplay}</span>
    </script>

    <script id="actionsTemplate" type="text/x-template">
        <div class="d-flex justify-content-center flex-wrap gap-2 table-actions" role="group">
            <a href="@Url.Action("Details", "JournalEntries")/${Id}" class="btn btn-sm btn-outline-info" title="عرض" asp-require-permission="journal.view">
                <i class="fas fa-eye"></i>
            </a>
            ${if(IsDraft)}
            <a href="@Url.Action("Edit", "JournalEntries")/${Id}" class="btn btn-sm btn-outline-warning" title="تعديل" asp-require-permission="journal.edit">
                <i class="fas fa-edit"></i>
            </a>
            <button type="button" class="btn btn-sm btn-outline-success btn-post-entry" data-id="${Id}" data-number="${Number}" title="ترحيل" asp-require-permission="journal.approve">
                <i class="fas fa-share"></i>
            </button>
            ${/if}
            <a href="@Url.Action("Print", "JournalEntries")/${Id}" target="_blank" class="btn btn-sm btn-outline-secondary" title="طباعة">
                <i class="fas fa-print"></i>
            </a>
            ${if(CanDelete)}
            <button type="button" class="btn btn-sm btn-outline-danger btn-delete-entry" data-id="${Id}" data-number="${Number}" title="إلغاء" asp-require-permission="journal.delete">
                <i class="fas fa-trash"></i>
            </button>
            ${/if}
        </div>
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            var dataUrl = '@Url.Action("UrlDatasourceJournalEntries", "JournalEntries")';
            var summaryUrl = '@Url.Action("Summary", "JournalEntries")';
            var postUrlBase = '@Url.Action("Post", "JournalEntries")';
            var deleteUrlBase = '@Url.Action("Delete", "JournalEntries")';
            var storageKey = 'journalEntries.index.filters.v2';

            var gridElement = document.getElementById('journalEntriesGrid');
            var searchInput = document.getElementById('quickSearch');
            var clearSearchButton = document.getElementById('clearQuickSearch');
            var refreshButton = document.getElementById('refreshGrid');
            var unbalancedToggle = document.getElementById('showUnbalancedOnly');
            var activeFiltersContainer = document.getElementById('activeFilters');
            var activeFiltersCount = document.getElementById('activeFiltersCount');
            var resultInfo = document.getElementById('gridResultInfo');
            var groupingInfo = document.getElementById('groupingInfo');
            var lastRefreshAt = document.getElementById('lastRefreshAt');
            var summaryInsight = document.getElementById('summaryInsight');
            var insightsPanel = document.getElementById('insightsPanel');
            var smartSuggestions = document.getElementById('smartSuggestions');
            var groupSelect = document.getElementById('groupBy');

            var summaryFields = {
                total: document.getElementById('summaryTotal'),
                totalStatus: document.getElementById('summaryTotalStatus'),
                unbalanced: document.getElementById('summaryUnbalanced'),
                debit: document.getElementById('summaryDebit'),
                credit: document.getElementById('summaryCredit'),
                ratio: document.getElementById('summaryBalanceRatio')
            };

            var filterControls = {
                fromDate: document.getElementById('fromDate'),
                toDate: document.getElementById('toDate'),
                branchId: document.getElementById('branchFilter'),
                status: document.getElementById('statusFilter'),
                groupBy: groupSelect,
                searchTerm: searchInput
            };

            var lastKnownCount = 0;

            if (!gridElement || !gridElement.ej2_instances || !gridElement.ej2_instances.length) {
                return;
            }

            var grid = gridElement.ej2_instances[0];
            var trackedRequestTypes = ['paging', 'sorting', 'filtering', 'searching', 'grouping', 'ungrouping', 'refresh'];
            var antiForgeryInput = document.querySelector('#antiForgeryForm input[name="__RequestVerificationToken"]');
            var antiForgeryToken = antiForgeryInput ? antiForgeryInput.value : null;

            if (!antiForgeryToken) {
                console.warn('Anti-forgery token was not found. Requests may be rejected.');
            }

            function loadPersistedFilters() {
                try {
                    var stored = localStorage.getItem(storageKey);
                    return stored ? JSON.parse(stored) : null;
                } catch (error) {
                    console.warn('Failed to parse stored filters.', error);
                    return null;
                }
            }

            function persistFilters(values) {
                try {
                    localStorage.setItem(storageKey, JSON.stringify(values));
                } catch (error) {
                    console.warn('Failed to persist filters.', error);
                }
            }

            function clearPersistedFilters() {
                try {
                    localStorage.removeItem(storageKey);
                } catch (error) {
                    console.warn('Failed to clear stored filters.', error);
                }
            }

            function applyStoredFilters() {
                var stored = loadPersistedFilters();
                if (!stored) {
                    return;
                }

                if (filterControls.fromDate && stored.fromDate) {
                    filterControls.fromDate.value = stored.fromDate;
                }
                if (filterControls.toDate && stored.toDate) {
                    filterControls.toDate.value = stored.toDate;
                }
                if (filterControls.branchId && typeof stored.branchId === 'string') {
                    setSelectValue(filterControls.branchId, stored.branchId);
                }
                if (filterControls.status && typeof stored.status === 'string') {
                    setSelectValue(filterControls.status, stored.status);
                }
                if (filterControls.groupBy && typeof stored.groupBy === 'string') {
                    setSelectValue(filterControls.groupBy, stored.groupBy);
                }
                if (unbalancedToggle && stored.showUnbalancedOnly === true) {
                    unbalancedToggle.checked = true;
                }
                if (filterControls.searchTerm && typeof stored.searchTerm === 'string') {
                    filterControls.searchTerm.value = stored.searchTerm;
                }
            }

            function setSelectValue(selectElement, value) {
                if (!selectElement) {
                    return;
                }
                var found = Array.prototype.some.call(selectElement.options, function (option) {
                    return option.value === value;
                });
                if (found) {
                    selectElement.value = value;
                } else {
                    selectElement.selectedIndex = 0;
                }
            }

            function gatherFilterParameters(searchValue) {
                return {
                    fromDate: filterControls.fromDate ? filterControls.fromDate.value : '',
                    toDate: filterControls.toDate ? filterControls.toDate.value : '',
                    branchId: filterControls.branchId ? filterControls.branchId.value : '',
                    status: filterControls.status ? filterControls.status.value : '',
                    groupBy: filterControls.groupBy ? filterControls.groupBy.value : '',
                    showUnbalancedOnly: unbalancedToggle && unbalancedToggle.checked ? 'true' : '',
                    searchTerm: (searchValue || (filterControls.searchTerm ? filterControls.searchTerm.value : '') || '').trim()
                };
            }

            function buildQuery(searchValue) {
                var query = new ej.data.Query();
                var params = gatherFilterParameters(searchValue);
                Object.keys(params).forEach(function (key) {
                    if (params[key]) {
                        query = query.addParams(key, params[key]);
                    }
                });
                return query;
            }

            function buildQueryString(params) {
                var query = new URLSearchParams();
                Object.keys(params).forEach(function (key) {
                    var value = params[key];
                    if (value !== undefined && value !== null && value !== '') {
                        query.append(key, value);
                    }
                });
                return query.toString();
            }

            function formatNumber(value) {
                var number = Number(value || 0);
                return number.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 2 });
            }

            function formatPercentage(value) {
                var number = Number(value || 0);
                return number.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 1 }) + '%';
            }

            function updateSummary(searchValue) {
                if (!summaryUrl) {
                    return;
                }

                var params = gatherFilterParameters(searchValue);
                var queryString = buildQueryString(params);
                var url = summaryUrl + (queryString ? ('?' + queryString) : '');

                fetch(url, { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
                    .then(function (response) {
                        if (!response.ok) {
                            throw new Error('فشل في تحميل الملخص');
                        }
                        return response.json();
                    })
                    .then(function (data) {
                        var totalEntries = Number(data.totalEntries || 0);
                        var unbalancedEntries = Number(data.unbalancedEntries || 0);
                        var balancedRatio = totalEntries > 0 ? ((totalEntries - unbalancedEntries) / totalEntries) * 100 : 0;

                        summaryFields.total.textContent = formatNumber(totalEntries);
                        summaryFields.totalStatus.textContent = data.statusSummary || '—';
                        summaryFields.unbalanced.textContent = formatNumber(unbalancedEntries);
                        summaryFields.debit.textContent = formatNumber(data.totalDebit);
                        summaryFields.credit.textContent = formatNumber(data.totalCredit);
                        summaryFields.ratio.textContent = formatPercentage(balancedRatio);

                        renderInsightMessage(totalEntries, unbalancedEntries, balancedRatio);
                        renderSmartSuggestions(totalEntries, unbalancedEntries, data.totalDebit, data.totalCredit);
                    })
                    .catch(function (error) {
                        console.warn(error);
                        summaryInsight.textContent = 'تعذر تحديث الملخص في الوقت الحالي.';
                    });
            }

            function renderInsightMessage(total, unbalanced, ratio) {
                if (total === 0) {
                    summaryInsight.textContent = 'ابدأ بإضافة القيود لعرض الإحصائيات والتقارير.';
                    return;
                }

                if (unbalanced > 0) {
                    summaryInsight.textContent = 'هناك ' + unbalanced + ' قيود تحتاج إلى مراجعة لتحقيق التوازن.';
                } else if (ratio >= 99) {
                    summaryInsight.textContent = 'أداء ممتاز! جميع القيود الحالية متوازنة.';
                } else {
                    summaryInsight.textContent = 'الغالبية العظمى من القيود متوازنة. استمر في مراقبة الأداء.';
                }
            }

            function renderSmartSuggestions(total, unbalanced, totalDebit, totalCredit) {
                if (!smartSuggestions) {
                    return;
                }

                smartSuggestions.innerHTML = '';

                var suggestions = [];

                if (total === 0) {
                    suggestions.push('استخدم زر "إضافة قيد جديد" لبدء إنشاء أول قيد.');
                } else {
                    if (unbalanced > 0) {
                        suggestions.push('قم بتطبيق مرشح "عرض القيود غير المتوازنة" لمراجعة الفروقات مباشرة.');
                    }
                    if (Math.abs(Number(totalDebit || 0) - Number(totalCredit || 0)) > 0.01) {
                        suggestions.push('راجع القيود ذات الفروقات الكبيرة بين المدين والدائن للتأكد من صحة الإدخالات.');
                    }
                    suggestions.push('جرّب تجميع النتائج حسب الفرع أو الحالة للحصول على رؤى أكثر دقة.');
                }

                if (suggestions.length > 0) {
                    suggestions.forEach(function (tip) {
                        var li = document.createElement('li');
                        li.textContent = tip;
                        smartSuggestions.appendChild(li);
                    });
                    insightsPanel.hidden = false;
                } else {
                    insightsPanel.hidden = true;
                }
            }

            function buildRequestOptions(options) {
                var headers = Object.assign({}, options.headers);
                if (antiForgeryToken) {
                    headers['RequestVerificationToken'] = antiForgeryToken;
                }
                return Object.assign({}, options, { headers: headers });
            }

            function getQuickSearchValue() {
                return searchInput ? searchInput.value.trim() : '';
            }

            function updateFilterChips(searchValue) {
                if (!activeFiltersContainer || !activeFiltersCount) {
                    return;
                }

                var params = gatherFilterParameters(searchValue);
                var chips = [];

                if (params.fromDate) {
                    chips.push({ key: 'fromDate', label: 'من: ' + params.fromDate });
                }
                if (params.toDate) {
                    chips.push({ key: 'toDate', label: 'إلى: ' + params.toDate });
                }
                if (params.branchId) {
                    var branchSelect = filterControls.branchId;
                    var branchText = branchSelect && branchSelect.options[branchSelect.selectedIndex] ? branchSelect.options[branchSelect.selectedIndex].text : params.branchId;
                    chips.push({ key: 'branchFilter', label: 'الفرع: ' + branchText });
                }
                if (params.status) {
                    var statusSelect = filterControls.status;
                    var statusText = statusSelect && statusSelect.options[statusSelect.selectedIndex] ? statusSelect.options[statusSelect.selectedIndex].text : params.status;
                    chips.push({ key: 'statusFilter', label: 'الحالة: ' + statusText });
                }
                if (params.showUnbalancedOnly === 'true') {
                    chips.push({ key: 'showUnbalancedOnly', label: 'غير متوازنة فقط' });
                }
                if (params.searchTerm) {
                    chips.push({ key: 'searchTerm', label: 'بحث: ' + params.searchTerm });
                }

                activeFiltersContainer.innerHTML = '';
                chips.forEach(function (chip) {
                    var chipElement = document.createElement('span');
                    chipElement.className = 'filter-chip';
                    chipElement.dataset.key = chip.key;
                    chipElement.innerHTML = '<span>' + chip.label + '</span><button type="button" aria-label="إزالة الفلتر"><i class="fas fa-times"></i></button>';
                    activeFiltersContainer.appendChild(chipElement);
                });

                activeFiltersCount.textContent = chips.length;
                activeFiltersCount.classList.toggle('d-none', chips.length === 0);
            }

            function updateResultsInfo(args) {
                if (!resultInfo) {
                    return;
                }

                var pageInfo = grid.pageSettings;
                var totalRecords = (args && typeof args.count === 'number') ? args.count : lastKnownCount;
                if (!totalRecords) {
                    totalRecords = grid.currentViewData.length;
                }
                var currentPage = pageInfo.currentPage || 1;
                var pageSize = pageInfo.pageSize || 25;
                var start = ((currentPage - 1) * pageSize) + 1;
                var end = Math.min(currentPage * pageSize, totalRecords);

                if (totalRecords === 0) {
                    resultInfo.textContent = 'لا توجد بيانات مطابقة للمرشحات الحالية';
                } else {
                    resultInfo.textContent = 'عرض ' + start + ' - ' + end + ' من ' + totalRecords + ' قيد';
                }

                if (totalRecords) {
                    lastKnownCount = totalRecords;
                }
            }

            function updateGroupingInfo() {
                if (!groupingInfo) {
                    return;
                }

                var groupedColumns = grid.groupSettings && grid.groupSettings.columns ? grid.groupSettings.columns : [];
                if (groupedColumns.length > 0) {
                    groupingInfo.hidden = false;
                    groupingInfo.textContent = 'مجموعة حسب: ' + groupedColumns.join(', ');
                } else {
                    groupingInfo.hidden = true;
                }
            }

            function persistCurrentFilters(searchValue) {
                var params = gatherFilterParameters(searchValue);
                persistFilters({
                    fromDate: params.fromDate || '',
                    toDate: params.toDate || '',
                    branchId: params.branchId || '',
                    status: params.status || '',
                    groupBy: params.groupBy || '',
                    showUnbalancedOnly: params.showUnbalancedOnly === 'true',
                    searchTerm: params.searchTerm || ''
                });
            }

            function reloadGrid() {
                showLoading();
                var searchValue = getQuickSearchValue();
                grid.query = buildQuery(searchValue);
                var normalizedSearch = (searchValue || '').trim();
                if (grid.searchSettings.key !== normalizedSearch) {
                    grid.searchSettings.key = normalizedSearch;
                }
                persistCurrentFilters(searchValue);
                updateFilterChips(searchValue);
                updateSummary(searchValue);
                grid.refresh();
            }

            function applyStoredGrouping() {
                var stored = loadPersistedFilters();
                if (!stored || !stored.groupBy) {
                    return;
                }
                grid.clearGrouping();
                grid.groupColumn(stored.groupBy);
            }

            function resetFilterByKey(key) {
                switch (key) {
                    case 'fromDate':
                        if (filterControls.fromDate) {
                            filterControls.fromDate.value = '';
                        }
                        break;
                    case 'toDate':
                        if (filterControls.toDate) {
                            filterControls.toDate.value = '';
                        }
                        break;
                    case 'branchFilter':
                        if (filterControls.branchId) {
                            filterControls.branchId.selectedIndex = 0;
                        }
                        break;
                    case 'statusFilter':
                        if (filterControls.status) {
                            filterControls.status.selectedIndex = 0;
                        }
                        break;
                    case 'showUnbalancedOnly':
                        if (unbalancedToggle) {
                            unbalancedToggle.checked = false;
                        }
                        break;
                    case 'searchTerm':
                        if (searchInput) {
                            searchInput.value = '';
                        }
                        break;
                }
            }

            function updateGridHeight() {
                if (!gridElement) {
                    return;
                }

                var gridRect = gridElement.getBoundingClientRect();
                var viewportHeight = window.visualViewport && typeof window.visualViewport.height === 'number'
                    ? window.visualViewport.height
                    : window.innerHeight;
                var availableHeight = viewportHeight - gridRect.top - 32;
                grid.height = Math.max(Math.round(availableHeight), 420);
            }

            applyStoredFilters();

            grid.query = buildQuery(getQuickSearchValue());
            grid.dataSource = new ej.data.DataManager({
                url: dataUrl,
                adaptor: new ej.data.UrlAdaptor()
            });
            grid.searchSettings = {
                fields: ['Number', 'Description', 'Reference', 'BranchName', 'CreatedByName', 'StatusDisplay', 'TotalDebitFormatted', 'TotalCreditFormatted'],
                operator: 'contains',
                key: '',
                ignoreCase: true
            };
            grid.sortSettings = { columns: [{ field: 'Date', direction: 'Descending' }] };
            grid.groupSettings = { showDropArea: false };

            applyStoredGrouping();
            updateFilterChips(getQuickSearchValue());
            updateSummary(getQuickSearchValue());
            updateGridHeight();
            window.addEventListener('resize', updateGridHeight);
            if (window.visualViewport) {
                window.visualViewport.addEventListener('resize', updateGridHeight);
            }
            if (typeof ResizeObserver !== 'undefined') {
                var layoutObserver = new ResizeObserver(function () {
                    updateGridHeight();
                });
                var cardElement = document.querySelector('.journal-shell');
                if (cardElement) {
                    layoutObserver.observe(cardElement);
                }
            }

            grid.rowDataBound = function (args) {
                if (!args || !args.row) {
                    return;
                }
                args.row.classList.remove('unbalanced-entry');
                if (args.data && args.data.IsBalanced === false) {
                    args.row.classList.add('unbalanced-entry');
                }
            };

            grid.actionBegin = function (args) {
                if (trackedRequestTypes.indexOf(args.requestType) > -1) {
                    showLoading();
                }
            };

            grid.actionComplete = function (args) {
                hideLoading();
                updateResultsInfo(args);
                updateGroupingInfo();
                if (args && typeof args.count === 'number') {
                    lastKnownCount = args.count;
                }
                var timestamp = new Date().toLocaleString();
                if (lastRefreshAt) {
                    lastRefreshAt.textContent = timestamp;
                }
            };

            grid.actionFailure = function () {
                hideLoading();
            };

            ['fromDate', 'toDate', 'branchFilter', 'statusFilter'].forEach(function (id) {
                var element = document.getElementById(id);
                if (!element) {
                    return;
                }
                element.addEventListener('change', function () {
                    grid.pageSettings.currentPage = 1;
                    reloadGrid();
                });
            });

            if (groupSelect) {
                groupSelect.addEventListener('change', function (event) {
                    grid.clearGrouping();
                    var value = event.target.value;
                    if (value) {
                        grid.groupColumn(value);
                    }
                    updateGroupingInfo();
                    grid.pageSettings.currentPage = 1;
                    reloadGrid();
                });
            }

            if (unbalancedToggle) {
                unbalancedToggle.addEventListener('change', function () {
                    grid.pageSettings.currentPage = 1;
                    reloadGrid();
                });
            }

            if (activeFiltersContainer) {
                activeFiltersContainer.addEventListener('click', function (event) {
                    var button = event.target.closest('button');
                    if (!button) {
                        return;
                    }
                    var chip = button.closest('.filter-chip');
                    if (!chip) {
                        return;
                    }
                    var key = chip.dataset.key;
                    if (!key) {
                        return;
                    }
                    resetFilterByKey(key);
                    grid.pageSettings.currentPage = 1;
                    reloadGrid();
                });
            }

            if (clearSearchButton) {
                clearSearchButton.addEventListener('click', function () {
                    if (!searchInput) {
                        return;
                    }
                    if (searchInput.value === '') {
                        reloadGrid();
                        return;
                    }
                    searchInput.value = '';
                    grid.pageSettings.currentPage = 1;
                    reloadGrid();
                });
            }

            if (refreshButton) {
                refreshButton.addEventListener('click', function () {
                    grid.pageSettings.currentPage = 1;
                    reloadGrid();
                });
            }

            var searchDebounce;
            if (searchInput) {
                searchInput.addEventListener('keyup', function (event) {
                    if (event.key === 'Enter') {
                        event.preventDefault();
                        grid.pageSettings.currentPage = 1;
                        reloadGrid();
                    }
                });

                searchInput.addEventListener('input', function () {
                    clearTimeout(searchDebounce);
                    searchDebounce = setTimeout(function () {
                        grid.pageSettings.currentPage = 1;
                        reloadGrid();
                    }, 350);
                });
            }

            var resetButton = document.getElementById('resetFilters');
            if (resetButton) {
                resetButton.addEventListener('click', function () {
                    if (filterControls.fromDate) {
                        filterControls.fromDate.value = '';
                    }
                    if (filterControls.toDate) {
                        filterControls.toDate.value = '';
                    }
                    if (filterControls.branchId) {
                        filterControls.branchId.selectedIndex = 0;
                    }
                    if (filterControls.status) {
                        filterControls.status.selectedIndex = 0;
                    }
                    if (groupSelect) {
                        groupSelect.value = '';
                        grid.clearGrouping();
                    }
                    if (unbalancedToggle) {
                        unbalancedToggle.checked = false;
                    }
                    if (searchInput) {
                        searchInput.value = '';
                    }

                    grid.clearFiltering();
                    grid.clearSorting();
                    grid.clearGrouping();
                    grid.searchSettings.key = '';
                    grid.pageSettings.currentPage = 1;
                    clearPersistedFilters();
                    reloadGrid();
                });
            }

            grid.toolbarClick = function (args) {
                if (!args.item || typeof args.item.id !== 'string') {
                    return;
                }
                var id = args.item.id.toLowerCase();
                if (id.indexOf('excelexport') !== -1) {
                    grid.excelExport({
                        fileName: 'journal-entries.xlsx',
                        header: {
                            headerRows: 2,
                            rows: [
                                { cells: [{ colSpan: 7, value: 'قائمة القيود المالية', style: { fontSize: 16, bold: true, hAlign: 'Right' } }] },
                                { cells: [{ colSpan: 7, value: 'تاريخ التصدير: ' + new Date().toLocaleString(), style: { hAlign: 'Right' } }] }
                            ]
                        }
                    });
                    args.cancel = true;
                }
            };

            document.getElementById('journalEntriesGrid').addEventListener('click', function (event) {
                var postButton = event.target.closest('.btn-post-entry');
                if (postButton) {
                    var postId = postButton.getAttribute('data-id');
                    var postNumber = postButton.getAttribute('data-number');
                    if (!postId) {
                        return;
                    }

                    if (!confirm('هل تريد ترحيل القيد رقم ' + postNumber + '?')) {
                        return;
                    }

                    showLoading();
                    $.ajax(buildRequestOptions({
                        url: postUrlBase + '/' + postId,
                        type: 'POST',
                        success: function () {
                            hideLoading();
                            grid.refresh();
                            updateSummary(getQuickSearchValue());
                            if (window.swal) {
                                swal({ title: 'تم الترحيل بنجاح', icon: 'success', button: 'حسناً' });
                            } else {
                                alert('تم ترحيل القيد بنجاح');
                            }
                        },
                        error: function (xhr) {
                            hideLoading();
                            var message = xhr.responseText || 'تعذر ترحيل القيد.';
                            if (window.swal) {
                                swal({ title: 'خطأ', text: message, icon: 'error', button: 'إغلاق' });
                            } else {
                                alert(message);
                            }
                        }
                    }));
                    return;
                }

                var deleteButton = event.target.closest('.btn-delete-entry');
                if (!deleteButton) {
                    return;
                }

                var deleteId = deleteButton.getAttribute('data-id');
                var deleteNumber = deleteButton.getAttribute('data-number');
                if (!deleteId) {
                    return;
                }

                if (!confirm('هل تريد إلغاء القيد رقم ' + deleteNumber + '?')) {
                    return;
                }

                showLoading();
                $.ajax(buildRequestOptions({
                    url: deleteUrlBase + '/' + deleteId,
                    type: 'POST',
                    success: function () {
                        hideLoading();
                        grid.refresh();
                        updateSummary(getQuickSearchValue());
                        if (window.swal) {
                            swal({ title: 'تم الإلغاء بنجاح', icon: 'success', button: 'حسناً' });
                        } else {
                            alert('تم إلغاء القيد بنجاح');
                        }
                    },
                    error: function (xhr) {
                        hideLoading();
                        var message = xhr.responseText || 'تعذر إلغاء القيد.';
                        if (window.swal) {
                            swal({ title: 'خطأ', text: message, icon: 'error', button: 'إغلاق' });
                        } else {
                            alert(message);
                        }
                    }
                }));
            });
        });
    </script>
}
