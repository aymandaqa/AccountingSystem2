@using Microsoft.AspNetCore.Authorization
@model AccountingSystem.ViewModels.JournalEntryManagementViewModel
@inject IAuthorizationService AuthorizationService

@{
    ViewData["Title"] = "إدارة القيود المالية";
    var rtl = System.Globalization.CultureInfo.CurrentUICulture.TextInfo.IsRightToLeft;
    var canEdit = (await AuthorizationService.AuthorizeAsync(User, "journal.edit")).Succeeded;
    var canDelete = (await AuthorizationService.AuthorizeAsync(User, "journal.delete")).Succeeded;

    var dataUrl = Url.Action("UrlDatasourceJournalEntries", "JournalEntries");
    var createUrl = Url.Action("Create", "JournalEntries");
    var editUrl = Url.Action("Edit", "JournalEntries", new { id = "__id__" });
    var detailsUrl = Url.Action("Details", "JournalEntries", new { id = "__id__" });
    var printUrl = Url.Action("Print", "JournalEntries", new { id = "__id__" });
    var deleteUrl = Url.Action("Delete", "JournalEntries");

    var toolbarItems = new List<object>
    {
        new { id = "JournalEntries_Add", text = "إضافة", prefixIcon = "e-add" },
        new { id = "JournalEntries_Edit", text = "تعديل", prefixIcon = "e-edit" },
        new { id = "JournalEntries_Delete", text = "حذف", prefixIcon = "e-delete" },
        new { id = "JournalEntries_Details", text = "عرض", prefixIcon = "e-file" },
        new { id = "JournalEntries_Print", text = "طباعة", prefixIcon = "e-print" },
        new { id = "JournalEntries_Refresh", text = "تحديث", prefixIcon = "e-refresh" },
        "Search"
    };
}

<section class="container py-4">
    <div class="mb-4">
        <h2 class="mb-1 text-primary">إدارة القيود المالية</h2>
        <p class="text-muted mb-0">استخدم عوامل التصفية والجدول أدناه لاستعراض القيود وفرزها والبحث داخلها.</p>
    </div>

    <div class="card mb-4 shadow-sm">
        <div class="card-body">
            <div class="row g-3 align-items-end">
                <div class="col-sm-6 col-lg-3">
                    <label for="fromDate" class="form-label">من تاريخ</label>
                    <input type="date" id="fromDate" class="form-control" />
                </div>
                <div class="col-sm-6 col-lg-3">
                    <label for="toDate" class="form-label">إلى تاريخ</label>
                    <input type="date" id="toDate" class="form-control" />
                </div>
                <div class="col-sm-6 col-lg-3">
                    <label for="branchFilter" class="form-label">الفرع</label>
                    <select id="branchFilter" class="form-select">
                        <option value="">كل الفروع</option>
                        @foreach (var branch in Model.Branches)
                        {
                            <option value="@branch.Value">@branch.Text</option>
                        }
                    </select>
                </div>
                <div class="col-sm-6 col-lg-3">
                    <label for="statusFilter" class="form-label">الحالة</label>
                    <select id="statusFilter" class="form-select">
                        <option value="">كل الحالات</option>
                        @foreach (var status in Model.Statuses)
                        {
                            <option value="@status.Value">@status.Text</option>
                        }
                    </select>
                </div>
                <div class="col-sm-8 col-lg-4">
                    <label for="searchTerm" class="form-label">بحث سريع</label>
                    <input type="search" id="searchTerm" class="form-control" placeholder="ابحث عن رقم القيد أو الوصف أو المرجع" />
                </div>
                <div class="col-sm-4 col-lg-2 d-grid">
                    <button type="button" id="applyFilters" class="btn btn-primary">تطبيق</button>
                </div>
                <div class="col-sm-4 col-lg-2 d-grid">
                    <button type="button" id="resetFilters" class="btn btn-light border">إعادة التعيين</button>
                </div>
            </div>
        </div>
    </div>

    <div class="card shadow-sm">
        <div class="card-body">
            <div class="mb-3 d-flex align-items-center justify-content-between flex-wrap gap-2">
                <div class="d-flex align-items-center gap-2">
                    <span class="badge bg-primary-subtle text-primary">جدول القيود</span>
                </div>
                <div class="text-muted small">يتم تحميل البيانات آليًا عبر مصدر بيانات بعيد.</div>
            </div>

            <ejs-grid id="JournalEntriesGrid" gridLines="Both" enableRtl="@rtl"
                      allowPaging="true" allowSorting="true" allowFiltering="true"
                      height="650" toolbarClick="onToolbarClick" actionBegin="onActionBegin"
                      toolbar="@toolbarItems"
                      allowSelection="true">
                <e-grid-selectionsettings type="Single"></e-grid-selectionsettings>
                <e-grid-pagesettings pageCount="5" pageSizes="true"></e-grid-pagesettings>
                <e-grid-filterSettings type="Menu" immediateModeDelay="100"></e-grid-filterSettings>
                <e-grid-editSettings allowAdding="false" allowDeleting="false" allowEditing="false"></e-grid-editSettings>
                <e-data-manager url="@dataUrl" adaptor="UrlAdaptor"></e-data-manager>
                <e-grid-columns>
                    <e-grid-column field="Id" isPrimaryKey="true" visible="false" allowEditing="false" width="50"></e-grid-column>
                    <e-grid-column field="Number" headerText="رقم القيد" width="140"></e-grid-column>
                    <e-grid-column field="Date" headerText="التاريخ" type="date" format="dd/MM/yyyy" width="140"></e-grid-column>
                    <e-grid-column field="Description" headerText="الوصف" width="200"></e-grid-column>
                    <e-grid-column field="Reference" headerText="المرجع" width="140"></e-grid-column>
                    <e-grid-column field="BranchName" headerText="الفرع" width="150"></e-grid-column>
                    <e-grid-column field="CreatedByName" headerText="مدخل القيد" width="160"></e-grid-column>
                    <e-grid-column field="TotalDebit" headerText="إجمالي المدين" textAlign="Right" format="N2" width="140"></e-grid-column>
                    <e-grid-column field="TotalCredit" headerText="إجمالي الدائن" textAlign="Right" format="N2" width="140"></e-grid-column>
                    <e-grid-column field="LinesCount" headerText="عدد البنود" textAlign="Center" width="120"></e-grid-column>
                    <e-grid-column field="StatusDisplay" headerText="الحالة" width="140"></e-grid-column>
                </e-grid-columns>
            </ejs-grid>
        </div>
    </div>
</section>

<form id="antiForgeryForm" asp-antiforgery="true"></form>

@section Scripts {
    <script>
        const endpoints = {
            data: '@dataUrl',
            create: '@createUrl',
            edit: '@editUrl',
            details: '@detailsUrl',
            print: '@printUrl',
            delete: '@deleteUrl'
        };

        const permissions = {
            canEdit: @canEdit.ToString().ToLower(),
            canDelete: @canDelete.ToString().ToLower()
        };

        const filterControls = {
            fromDate: document.getElementById('fromDate'),
            toDate: document.getElementById('toDate'),
            branch: document.getElementById('branchFilter'),
            status: document.getElementById('statusFilter'),
            search: document.getElementById('searchTerm')
        };

        function getGridInstance() {
            const gridElement = document.getElementById('JournalEntriesGrid');
            if (!gridElement || !gridElement.ej2_instances || gridElement.ej2_instances.length === 0) {
                console.error('JournalEntries grid instance is not ready yet.');
                return null;
            }

            return gridElement.ej2_instances[0];
        }

        function getParamsObject() {
            return {
                fromDate: filterControls.fromDate.value,
                toDate: filterControls.toDate.value,
                branchId: filterControls.branch.value,
                status: filterControls.status.value,
                searchTerm: filterControls.search.value
            };
        }

        function buildQuery() {
            const query = new ej.data.Query();
            const parameters = getParamsObject();

            Object.entries(parameters).forEach(([key, value]) => {
                if (value) {
                    query.addParams(key, value);
                }
            });

            return query;
        }

        function applyFilters() {
            const grid = getGridInstance();
            if (!grid) {
                return;
            }

            grid.query = buildQuery();
            grid.refresh();
        }

        function resetFilters() {
            Object.values(filterControls).forEach(control => control.value = '');
            applyFilters();
        }

        function onActionBegin(args) {
            if (!args.data) {
                args.data = {};
            }

            Object.assign(args.data, getParamsObject());
        }

        function getSelectedEntry() {
            const grid = getGridInstance();
            if (!grid) {
                return null;
            }

            const records = grid.getSelectedRecords();
            return records && records.length > 0 ? records[0] : null;
        }

        function handleEdit() {
            if (!permissions.canEdit) {
                ej.popups.DialogUtility.alert({ title: 'صلاحيات', content: 'ليست لديك صلاحية التعديل.' });
                return;
            }

            const selected = getSelectedEntry();
            if (!selected) {
                ej.popups.DialogUtility.alert({ title: 'تعديل', content: 'يرجى اختيار قيد أولاً.' });
                return;
            }

            const url = endpoints.edit.replace('__id__', selected.Id);
            window.location.href = url;
        }

        function handleDetails() {
            const selected = getSelectedEntry();
            if (!selected) {
                ej.popups.DialogUtility.alert({ title: 'عرض', content: 'يرجى اختيار قيد أولاً.' });
                return;
            }

            const url = endpoints.details.replace('__id__', selected.Id);
            window.open(url, '_blank');
        }

        function handlePrint() {
            const selected = getSelectedEntry();
            if (!selected) {
                ej.popups.DialogUtility.alert({ title: 'طباعة', content: 'يرجى اختيار قيد أولاً.' });
                return;
            }

            const url = endpoints.print.replace('__id__', selected.Id);
            window.open(url, '_blank');
        }

        async function handleDelete() {
            if (!permissions.canDelete) {
                ej.popups.DialogUtility.alert({ title: 'صلاحيات', content: 'ليست لديك صلاحية الحذف.' });
                return;
            }

            const selected = getSelectedEntry();
            if (!selected) {
                ej.popups.DialogUtility.alert({ title: 'حذف', content: 'يرجى اختيار قيد أولاً.' });
                return;
            }

            const confirm = await ej.popups.DialogUtility.confirm({
                title: 'تأكيد الحذف',
                content: 'سيتم إلغاء القيد الحالي. هل تريد المتابعة؟',
                okButton: { text: 'نعم' },
                cancelButton: { text: 'لا' }
            }).then(value => value === 'ok');

            if (!confirm) {
                return;
            }

            const tokenInput = document.querySelector('#antiForgeryForm input[name="__RequestVerificationToken"]');
            const token = tokenInput ? tokenInput.value : null;

            try {
                const response = await fetch(endpoints.delete, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'RequestVerificationToken': token
                    },
                    body: new URLSearchParams({ id: selected.Id })
                });

                if (response.ok) {
                    const grid = getGridInstance();
                    if (grid) {
                        grid.refresh();
                    }
                } else {
                    const errorText = await response.text();
                    ej.popups.DialogUtility.alert({ title: 'خطأ', content: errorText || 'تعذر حذف القيد.' });
                }
            } catch (error) {
                ej.popups.DialogUtility.alert({ title: 'خطأ', content: 'حدث خطأ أثناء تنفيذ الطلب.' });
            }
        }

        function onToolbarClick(args) {
            switch (args.item.id) {
                case 'JournalEntries_Add':
                    window.location.href = endpoints.create;
                    break;
                case 'JournalEntries_Edit':
                    args.cancel = true;
                    handleEdit();
                    break;
                case 'JournalEntries_Delete':
                    args.cancel = true;
                    handleDelete();
                    break;
                case 'JournalEntries_Details':
                    args.cancel = true;
                    handleDetails();
                    break;
                case 'JournalEntries_Print':
                    args.cancel = true;
                    handlePrint();
                    break;
                case 'JournalEntries_Refresh':
                    args.cancel = true;
                    applyFilters();
                    break;
                default:
                    break;
            }
        }

        document.getElementById('applyFilters').addEventListener('click', applyFilters);
        document.getElementById('resetFilters').addEventListener('click', resetFilters);
        filterControls.search.addEventListener('keypress', function (event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                applyFilters();
            }
        });

        const grid = getGridInstance();
        if (grid) {
            grid.query = buildQuery();
        }
    </script>
}
