@using Microsoft.AspNetCore.Authorization
@model AccountingSystem.ViewModels.JournalEntryManagementViewModel
@inject IAuthorizationService AuthorizationService

@{
    ViewData["Title"] = "إدارة القيود المالية";
    var rtl = System.Globalization.CultureInfo.CurrentUICulture.TextInfo.IsRightToLeft;
    var canEdit = (await AuthorizationService.AuthorizeAsync(User, "journal.edit")).Succeeded;
    var canDelete = (await AuthorizationService.AuthorizeAsync(User, "journal.delete")).Succeeded;

    var dataUrl = Url.Action("UrlDatasourceJournalEntries", "JournalEntries");
    var createUrl = Url.Action("Create", "JournalEntries");
    var editUrl = Url.Action("Edit", "JournalEntries", new { id = "__id__" });
    var detailsUrl = Url.Action("Details", "JournalEntries", new { id = "__id__" });
    var printUrl = Url.Action("Print", "JournalEntries", new { id = "__id__" });
    var deleteUrl = Url.Action("Delete", "JournalEntries");

    var toolbarItems = new List<object>
    {
        new { id = "JournalEntries_Add", text = "إضافة", prefixIcon = "e-add" },
        new { id = "JournalEntries_Refresh", text = "تحديث", prefixIcon = "e-refresh" },
        new { id = "JournalEntries_ExcelExport", text = "تصدير إكسل", prefixIcon = "e-excelexport" },
        "Search"
    };
}

<div class="mb-4">
    <h2 class="mb-1 text-primary">إدارة القيود المالية</h2>
    <p class="text-muted mb-0">استخدم عوامل التصفية والجدول أدناه لاستعراض القيود وفرزها والبحث داخلها.</p>
</div>

<div class="card mb-4 shadow-sm">
    <div class="card-body">
        <div class="row g-3 align-items-end">
            <div class="col-sm-6 col-lg-3">
                <label for="fromDate" class="form-label">من تاريخ</label>
                <input type="date" id="fromDate" class="form-control" />
            </div>
            <div class="col-sm-6 col-lg-3">
                <label for="toDate" class="form-label">إلى تاريخ</label>
                <input type="date" id="toDate" class="form-control" />
            </div>
            <div class="col-sm-6 col-lg-3">
                <label for="branchFilter" class="form-label">الفرع</label>
                <select id="branchFilter" class="form-select">
                    <option value="">كل الفروع</option>
                    @foreach (var branch in Model.Branches)
                    {
                        <option value="@branch.Value">@branch.Text</option>
                    }
                </select>
            </div>
            <div class="col-sm-6 col-lg-3">
                <label for="statusFilter" class="form-label">الحالة</label>
                <select id="statusFilter" class="form-select">
                    <option value="">كل الحالات</option>
                    @foreach (var status in Model.Statuses)
                    {
                        <option value="@status.Value">@status.Text</option>
                    }
                </select>
            </div>
            <div class="col-sm-8 col-lg-4">
                <label for="searchTerm" class="form-label">بحث سريع</label>
                <input type="search" id="searchTerm" class="form-control" placeholder="ابحث عن رقم القيد أو الوصف أو المرجع" />
            </div>
            <div class="col-sm-4 col-lg-2 d-grid">
                <button type="button" id="applyFilters" class="btn btn-primary">تطبيق</button>
            </div>
            <div class="col-sm-4 col-lg-2 d-grid">
                <button type="button" id="resetFilters" class="btn btn-light border">إعادة التعيين</button>
            </div>
        </div>
    </div>
</div>

<div class="card shadow-sm">
    <div class="card-body">
        <div class="mb-3 d-flex align-items-center justify-content-between flex-wrap gap-2">
            <div class="d-flex align-items-center gap-2">
                <span class="badge bg-primary-subtle text-primary">جدول القيود</span>
            </div>
            <div class="text-muted small">يتم تحميل البيانات آليًا عبر مصدر بيانات بعيد.</div>
        </div>

        <ejs-grid id="JournalEntriesGrid"
                  gridLines="Both"
                  enableRtl="true"
                  width="100%"
                  allowResizing="true"
                  enableStickyHeader="true"
                  allowGrouping="true"
                  allowTextWrap="true"
                  allowPaging="true"
                  allowSorting="true"
                  allowFiltering="true"
                  height="650"
                  toolbarClick="onToolbarClick"
                  actionBegin="onActionBegin"
                  created="onGridCreated"
                  rowDataBound="onRowDataBound"
                  toolbar="@toolbarItems"
                  allowSelection="true" allowExcelExport="true">
            <e-grid-selectionsettings type="Single"></e-grid-selectionsettings>
            <e-grid-pagesettings pageCount="5" pageSizes="true"></e-grid-pagesettings>
            <e-grid-filterSettings type="Excel" immediateModeDelay="100"></e-grid-filterSettings>
            <e-grid-editSettings allowAdding="false" allowDeleting="false" allowEditing="false"></e-grid-editSettings>
            <e-data-manager url="@dataUrl" adaptor="UrlAdaptor"></e-data-manager>
            <e-grid-columns>
                <e-grid-column field="Id" isPrimaryKey="true" visible="false" allowEditing="false" width="100%"></e-grid-column>
                <e-grid-column field="Number" headerText="رقم القيد" width="100%"></e-grid-column>
                <e-grid-column field="Date" headerText="التاريخ" type="date" format="dd/MM/yyyy HH:mm" width="100%"></e-grid-column>
                <e-grid-column field="Description" headerText="الوصف" width="100%"></e-grid-column>
                <e-grid-column field="Reference" headerText="المرجع" width="100%"></e-grid-column>
                <e-grid-column field="BranchName" headerText="الفرع" width="100%"></e-grid-column>
                <e-grid-column field="CreatedByName" headerText="مدخل القيد" width="100%"></e-grid-column>
                <e-grid-column field="TotalDebit" headerText="إجمالي المدين" textAlign="Right" format="N2" width="100%"></e-grid-column>
                <e-grid-column field="TotalCredit" headerText="إجمالي الدائن" textAlign="Right" format="N2" width="100%"></e-grid-column>
                <e-grid-column field="LinesCount" headerText="عدد البنود" textAlign="Center" width="100%"></e-grid-column>
                <e-grid-column field="StatusDisplay" headerText="الحالة" width="100%"></e-grid-column>
                <e-grid-column headerText="الخيارات" width="100%" textAlign="Center" template="#journalEntryActionsTemplate"></e-grid-column>
            </e-grid-columns>
        </ejs-grid>
    </div>
</div>


<script id="journalEntryActionsTemplate" type="text/x-template">
    <div class="d-flex justify-content-center gap-1">
        <button type="button" class="btn btn-sm btn-outline-primary" data-action="details" data-entry-id="${Id}" title="عرض">
            <span class="e-icons e-eye"></span>
        </button>
        <button type="button" class="btn btn-sm btn-outline-secondary" data-action="print" data-entry-id="${Id}" title="طباعة">
            <span class="e-icons e-print"></span>
        </button>
        @if (canEdit)
        {
                                                                                                <button type="button" class="btn btn-sm btn-outline-warning" data-action="edit" data-entry-id="${Id}" title="تعديل">
                                                                                                    <span class="e-icons e-edit"></span>
                                                                                                </button>
        }
        @if (canDelete)
        {
                                                                                                <button type="button" class="btn btn-sm btn-outline-danger" data-action="delete" data-entry-id="${Id}" title="حذف">
                                                                                                    <span class="e-icons e-delete"></span>
                                                                                                </button>
        }
    </div>
</script>

<form id="antiForgeryForm" asp-antiforgery="true"></form>

@section Scripts {
    <script>
        const endpoints = {
            data: '@dataUrl',
            create: '@createUrl',
            edit: '@editUrl',
            details: '@detailsUrl',
            print: '@printUrl',
            delete: '@deleteUrl'
        };

        const permissions = {
            canEdit: @canEdit.ToString().ToLowerInvariant(),
            canDelete: @canDelete.ToString().ToLowerInvariant()
        };

        const filterControls = {
            fromDate: document.getElementById('fromDate'),
            toDate: document.getElementById('toDate'),
            branch: document.getElementById('branchFilter'),
            status: document.getElementById('statusFilter'),
            search: document.getElementById('searchTerm')
        };

        const gridElement = document.getElementById('JournalEntriesGrid');

        function getGridInstance() {
            if (!gridElement || !Array.isArray(gridElement.ej2_instances) || gridElement.ej2_instances.length === 0) {
                return null;
            }

            return gridElement.ej2_instances[0];
        }

        function getParamsObject() {
            return {
                fromDate: filterControls.fromDate.value,
                toDate: filterControls.toDate.value,
                branchId: filterControls.branch.value,
                status: filterControls.status.value,
                searchTerm: filterControls.search.value
            };
        }

        function buildQuery() {
            const query = new ej.data.Query();
            const parameters = getParamsObject();

            Object.entries(parameters).forEach(([key, value]) => {
                if (value) {
                    query.addParams(key, value);
                }
            });

            return query;
        }

        function applyFilters() {
            const grid = getGridInstance();
            if (!grid) {
                return;
            }

            grid.query = buildQuery();
            grid.refresh();
        }

        function resetFilters() {
            Object.values(filterControls).forEach(control => control.value = '');
            applyFilters();
        }

        function onActionBegin(args) {
            if (!args.data) {
                args.data = {};
            }

            Object.assign(args.data, getParamsObject());
        }

        function getSelectedEntry() {
            const grid = getGridInstance();
            if (!grid) {
                return null;
            }

            const records = grid.getSelectedRecords();
            return records && records.length > 0 ? records[0] : null;
        }

        function getEntryById(entryId) {
            const grid = getGridInstance();
            if (!grid) {
                return null;
            }

            const parsedId = parseInt(entryId, 10);
            if (Number.isNaN(parsedId)) {
                return null;
            }

            return grid.currentViewData.find(item => item.Id === parsedId) || null;
        }

        function handleEdit(entry) {
            if (!permissions.canEdit) {
                ej.popups.DialogUtility.alert({ title: 'صلاحيات', content: 'ليست لديك صلاحية التعديل.' });
                return;
            }

            const selected = entry || getSelectedEntry();
            if (!selected) {
                ej.popups.DialogUtility.alert({ title: 'تعديل', content: 'يرجى اختيار قيد أولاً.' });
                return;
            }

            if (selected.Status !== 'Draft') {
                ej.popups.DialogUtility.alert({ title: 'تعديل', content: 'لا يمكن تعديل قيد مرحل أو غير مسودة.' });
                return;
            }

            const url = endpoints.edit.replace('__id__', selected.Id);
            window.location.href = url;
        }

        function handleDetails(entry) {
            const selected = entry || getSelectedEntry();
            if (!selected) {
                ej.popups.DialogUtility.alert({ title: 'عرض', content: 'يرجى اختيار قيد أولاً.' });
                return;
            }

            const url = endpoints.details.replace('__id__', selected.Id);
            window.open(url, '_blank');
        }

        function handlePrint(entry) {
            const selected = entry || getSelectedEntry();
            if (!selected) {
                ej.popups.DialogUtility.alert({ title: 'طباعة', content: 'يرجى اختيار قيد أولاً.' });
                return;
            }

            const url = endpoints.print.replace('__id__', selected.Id);
            window.open(url, '_blank');
        }

        async function handleDelete(entry) {
            if (!permissions.canDelete) {
                ej.popups.DialogUtility.alert({ title: 'صلاحيات', content: 'ليست لديك صلاحية الحذف.' });
                return;
            }

            const selected = entry || getSelectedEntry();
            if (!selected) {
                ej.popups.DialogUtility.alert({ title: 'حذف', content: 'يرجى اختيار قيد أولاً.' });
                return;
            }

            const confirm = await new Promise(resolve => {
                ej.popups.DialogUtility.confirm({
                    title: 'تأكيد الحذف',
                    content: 'سيتم إلغاء القيد الحالي. هل تريد المتابعة؟',
                    okButton: {
                        text: 'نعم',
                        click: () => resolve(true)
                    },
                    cancelButton: {
                        text: 'لا',
                        click: () => resolve(false)
                    }
                });
            });

            if (!confirm) {
                return;
            }

            const tokenInput = document.querySelector('#antiForgeryForm input[name="__RequestVerificationToken"]');
            const token = tokenInput ? tokenInput.value : null;

            try {
                const response = await fetch(endpoints.delete, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'RequestVerificationToken': token
                    },
                    body: new URLSearchParams({ id: selected.Id })
                });

                if (response.ok) {
                    const grid = getGridInstance();
                    if (grid) {
                        grid.refresh();
                    }
                } else {
                    const errorText = await response.text();
                    ej.popups.DialogUtility.alert({ title: 'خطأ', content: errorText || 'تعذر حذف القيد.' });
                }
            } catch (error) {
                ej.popups.DialogUtility.alert({ title: 'خطأ', content: 'حدث خطأ أثناء تنفيذ الطلب.' });
            }
        }

        function handleExcelExport() {
            const grid = getGridInstance();
            if (grid) {
                grid.excelExport();
            }
        }

        function onActionButtonClick(event) {
            const actionButton = event.target.closest('[data-action][data-entry-id]');
            if (!actionButton) {
                return;
            }

            const entry = getEntryById(actionButton.dataset.entryId);
            if (!entry) {
                return;
            }

            switch (actionButton.dataset.action) {
                case 'edit':
                    handleEdit(entry);
                    break;
                case 'delete':
                    handleDelete(entry);
                    break;
                case 'details':
                    handleDetails(entry);
                    break;
                case 'print':
                    handlePrint(entry);
                    break;
                default:
                    break;
            }
        }

        function onToolbarClick(args) {
            switch (args.item.id) {
                case 'JournalEntries_Add':
                    window.location.href = endpoints.create;
                    break;
                case 'JournalEntries_Refresh':
                    args.cancel = true;
                    applyFilters();
                    break;
                case 'JournalEntries_ExcelExport':
                    args.cancel = true;
                    handleExcelExport();
                    break;
                default:
                    break;
            }
        }

        function onRowDataBound(args) {
            const status = args?.data?.Status;
            if (!status || !args.row) {
                return;
            }

            const editButton = args.row.querySelector('[data-action="edit"]');
            if (editButton) {
                editButton.hidden = status !== 'Draft';
            }
        }

        function onGridCreated() {
            const grid = getGridInstance();
            if (!grid) {
                return;
            }

            grid.element.addEventListener('click', onActionButtonClick);
            grid.rowDataBound = onRowDataBound;
            grid.query = buildQuery();
        }

        document.getElementById('applyFilters').addEventListener('click', applyFilters);
        document.getElementById('resetFilters').addEventListener('click', resetFilters);
        filterControls.search.addEventListener('keypress', function (event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                applyFilters();
            }
        });
    </script>
}
